package:
  name: libnspr
  version: "4.35"
  epoch: 1
  description: "Netscape Portable Runtime (NSPR) provides a platform-neutral API for system level and libc-like functions."
  copyright:
    - license: MPL-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - mercurial
      - bash

var-transforms:
  - from: ${{package.version}}
    match: \.
    replace: _
    to: libnspr-package-version

pipeline:
  # we need to use runs because melange dont have a mercurial checkout pipeline yet
  - runs: |
      hg clone -r NSPR_${{vars.libnspr-package-version}}_RTM https://hg.mozilla.org/projects/nspr

  - uses: autoconf/configure
    with:
      dir: nspr
      opts: |
        --enable-64bit \
        --host=${{host.triplet.gnu}} \
        --target=${{host.triplet.gnu}} \
        --enable-optimize \
        --disable-debug \
        --prefix=/usr

  - uses: autoconf/make
    with:
      dir: nspr

  - uses: autoconf/make-install
    with:
      dir: nspr

  # Cleanup leftovers from the build.
  - runs: |
      rm -r "${{targets.contextdir}}"/usr/include/nspr/md
      rm -r "${{targets.contextdir}}"/usr/bin/compile-et.pl
      rm -r "${{targets.contextdir}}"/usr/bin/prerr.properties

  # Link the NSPR package config file into the right place.
  - working-directory: nspr
    runs: |
      mkdir -p "${{target.contextdir}}/usr/lib/pkgconfig/"
      ln -s nspr.pc "${{target.contextdir}}/usr/lib/pkgconfig/mozilla-nspr.pc"

  - uses: strip

subpackages:
  - name: libnspr-dev
    pipeline:
      - uses: split/dev

update:
  enabled: true
  release-monitor:
    identifier: 7953
