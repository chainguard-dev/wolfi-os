package:
  name: bun
  version: 1.1.22
  epoch: 0
  description: "Incredibly fast JavaScript runtime, bundler, test runner, and package manager - all in one"
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - bun-bootstrap # bun requires itself to build. this can get moved to our real build in the future
      - busybox
      - c-ares-dev
      - ccache
      - clang-16
      - clang-16-dev
      - cmake
      - coreutils
      - curl
      - git
      - glibc-iconv
      - go
      - icu-dev
      - libarchive-dev
      - libtool
      - llvm-lld-16
      - llvm16
      - nodejs
      - m4
      - mimalloc2-dev
      - perl
      - pkgconf
      - pkgconf-dev
      - python3-dev
      - ruby-3.3
      - rust
      - samurai
      - sed
      - sqlite-dev
      - zlib-dev
      - zstd-cmake
      - zstd-dev
      - zstd-static

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/oven-sh/bun
      expected-commit: d74a192345890e235b5e6dead080235c1917f44b
      tag: bun-v${{package.version}}
      recurse-submodules: true

  # bun requires a specific zig to build
  - runs: |
      bun install -g @oven/zig

      # "Modifying file https://github.com/oven-sh/bun/blob/main/CMakeLists.txt, removing flags Werror=uninitialized and  -Werror."
      sed -i '/-Werror=uninitialized/d' ./CMakeLists.txt
      sed -i '/-Werror/d' ./CMakeLists.txt
      sed -i 's/libzstd_static//' scripts/build-zstd.sh

  # build bun deps
  - runs: |
      cd scripts/
      bash ./update-submodules.sh --webkit
      bash ./build-boringssl
      bash ./build-lolhtml
      bash ./build-tinycc
      bash ./build-lshpack
      cd ../
      bun i
      cd test
      bun i
      cd ..
      make jsc-build-linux
      make jsc-copy-headers
      make runtime_js fallback_decoder bun_error node-fallbacks

  - runs: |
      export PATH="$PATH:/$HOME/.bun/bin"
      # Prefer wolfi libraries, when available
      cmake -B build-release -G Ninja \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DCMAKE_BUILD_TYPE=Release \
        -DWEBKIT_DIR=$(realpath src/bun.js/WebKit)/WebKitBuild/Release \
        -DUSE_STATIC_SQLITE=OFF \
        -DUSE_CUSTOM_ZLIB=OFF \
        -DUSE_CUSTOM_LIBDEFLATE=OFF \
        -DUSE_CUSTOM_LIBARCHIVE=OFF \
        -DUSE_CUSTOM_MIMALLOC=OFF \
        -DUSE_CUSTOM_ZSTD=OFF \
        -DUSE_CUSTOM_CARES=OFF \
        -DUSE_SYSTEM_ICU=ON
      cmake --build build-release

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      mv ./build-release/bun ${{targets.destdir}}/usr/bin

      # symlink bunx as bun: https://github.com/oven-sh/bun/blob/main/dockerhub/distroless/Dockerfile#L70
      ln -s /usr/bin/bun ${{targets.destdir}}/usr/bin/bunx

  - uses: strip

update:
  enabled: true
  github:
    identifier: oven-sh/bun
    use-tag: true
    strip-prefix: bun-v

test:
  pipeline:
    - runs: |
        bun --version
        touch foo.js
        #bunx prettier foo.js
