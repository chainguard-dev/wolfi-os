package:
  name: bun
  version: 1.1.29
  epoch: 0
  description: "Incredibly fast JavaScript runtime, bundler, test runner, and package manager - all in one"
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - build-base
      - bun-bootstrap # bun requires itself to build. this can get moved to our real build in the future
      - busybox
      - c-ares-dev
      - ccache
      - clang-16
      - clang-16-dev
      - cmake
      - coreutils
      - curl
      - git
      - glibc-iconv
      - go
      - icu-dev
      - libarchive-dev
      - libtool
      - llvm-lld-16
      - llvm16
      - m4
      - mimalloc2-dev
      - nodejs
      - perl
      - pkgconf
      - pkgconf-dev
      - python3-dev
      - ruby-3.3
      - rust
      - samurai
      - sed
      - sqlite-dev
      - zlib-dev
      - zstd-cmake
      - zstd-dev
      - zstd-static

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/oven-sh/bun
      expected-commit: 73c553b25ab06026acc628a95c5c65783f89e1e5
      tag: bun-v${{package.version}}

  - runs: |
      sed -i '/-Werror/d' cmake/targets/BuildBun.cmake
      ln -s /usr/lib/llvm16/lib/LLVMgold.so /usr/lib/LLVMgold.so
      # Urgh, wrong linker name
      sed -i 's|use-ld=lld.*|use-ld=ld.lld|' cmake/targets/BuildBun.cmake
      # Prefer wolfi libraries, when available
      cmake -B build-release -G Ninja \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_BUILD_TYPE=Release \
        -DUSE_STATIC_SQLITE=OFF \
        -DUSE_SYSTEM_ICU=ON
      # this feels dirty and wrong
      mkdir -p build-release/cares/lib
      cp /usr/lib/libcares_static.a build-release/cares/lib/libcares.a
      # maybe cmake custom target command to build cares was supposed
      # to be used ?
      cmake --build build-release

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      mv ./build-release/bun ${{targets.destdir}}/usr/bin

      # symlink bunx as bun: https://github.com/oven-sh/bun/blob/main/dockerhub/distroless/Dockerfile#L70
      ln -s /usr/bin/bun ${{targets.destdir}}/usr/bin/bunx

  - uses: strip

update:
  enabled: true
  github:
    identifier: oven-sh/bun
    use-tag: true
    strip-prefix: bun-v

test:
  pipeline:
    - runs: |
        bun --version
        touch foo.js
        #bunx prettier foo.js
