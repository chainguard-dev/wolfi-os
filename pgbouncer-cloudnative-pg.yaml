package:
  name: pgbouncer-cloudnative-pg
  version: 1.22.1.15
  epoch: 0
  description: CloudNativePG containing PgBouncer
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - pgbouncer

var-transforms:
  - from: ${{package.version}}
    match: '\.(\d+)$'
    replace: '-$1'
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/cloudnative-pg/pgbouncer-containers
      expected-commit: d1bcb28762f25d48330cd2de9375cdb4c488a393
      tag: v${{vars.mangled-package-version}}

  - runs: |
      mkdir -p "${{targets.contextdir}}"/var/log/pgbouncer
      mkdir -p "${{targets.contextdir}}"/var/run/pgbouncer
      mkdir -p "${{targets.contextdir}}"/etc/pgbouncer

      mv /etc/pgbouncer/pgbouncer.ini "${{targets.contextdir}}"/etc/pgbouncer/pgbouncer.ini.example
      mv /etc/pgbouncer/userlist.txt "${{targets.contextdir}}"/etc/pgbouncer/userlist.txt.example

      touch "${{targets.contextdir}}"/etc/pgbouncer/pgbouncer.ini "${{targets.contextdir}}"/etc/pgbouncer/userlist.txt

      # https://github.com/cloudnative-pg/pgbouncer-containers/blob/d1bcb28762f25d48330cd2de9375cdb4c488a393/Dockerfile#L78
      # we are going to call the script from /t to be able to use it as "./entrypoint.sh" in the entrypoint of the container image
      mkdir -p "${{targets.contextdir}}"/
      install -Dm755 entrypoint.sh "${{targets.contextdir}}"/entrypoint.sh

update:
  # Doesn't work with var transforms
  enabled: false
  manual: true
  github:
    identifier: cloudnative-pg/pgbouncer-containers
    strip-prefix: v
