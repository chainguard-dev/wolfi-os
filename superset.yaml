package:
  name: superset
  version: 4.0.0
  epoch: 6
  description: Data Visualization and Data Exploration Platform
  copyright:
    - license: Apache-2.0
  options:
    no-depends: true
  dependencies:
    runtime:
      # - to be added

environment:
  environment:
    HOME: /home/build
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - python-3.11-dev
      - zlib-dev
      - openldap-dev
      - py3.11-pip
      - py3-mysqlclient-wheel
      - nvm
      - mariadb-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apache/superset.git
      tag: ${{package.version}}
      expected-commit: c35842e9f1c987d5e684969540fea3d8a5d03ad9
  - runs: |
      python -m venv .venv
      source .venv/bin/activate

      pip install /usr/share/mysqlclient-*.whl
      pip install -r requirements/base.txt
      pip install .

  - runs: |
      source /usr/share/nvm/nvm.sh
      nvm install 16.20.2
      npm install -g node-gyp node-gyp-build

      cd superset-frontend
      npm ci
      npm run build

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/share/superset
      mv .venv ${{targets.destdir}}/usr/share/superset
      sed -i "s|/home/build|/usr/share/superset|g" ${{targets.destdir}}/usr/share/superset/.venv/bin/*

  - runs: |
      mkdir -p ${{targets.destdir}}/superset-frontend/
      mkdir -p ${{targets.destdir}}/usr/bin/

      cp -R ./superset ${{targets.destdir}}/
      cp setup.py MANIFEST.in README.md ${{targets.destdir}}/
      cp superset-frontend/package.json ${{targets.destdir}}/superset-frontend/
      cp  ./docker/run-server.sh ${{targets.destdir}}/usr/bin/

update:
  enabled: true
  github:
    identifier: 
    use-tag: true

test:
  environment:
      contents:
        packages:
          - wolfi-base
          - openssl
          - python-3.11
          - superset
  pipeline:
      - runs: |
          export SUPERSET_SECRET_KEY="$(openssl rand -base64 42)"
          superset --help



