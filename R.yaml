# Generated from https://git.alpinelinux.org/aports/plain/community/R/APKBUILD
package:
  name: R
  version: 4.3.1
  epoch: 1
  description: Language and environment for statistical computing
  copyright:
    - license: ( GPL-2.0-only OR GPL-3.0-only ) AND LGPL-2.1-or-later
  dependencies:
    runtime:
      - libgomp # This isn't caught with melange during the build.
      - busybox # The wrapper scripts need busybox.

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - build-base
      - automake
      - autoconf
      - bzip2-dev
      - curl-dev
      - gcc
      - gfortran
      - icu-dev
      - libjpeg-turbo
      - libpng-dev
      - make
      - openblas-dev
      - pcre2-dev
      - readline-dev
      - xz-dev
      - zlib-dev
      - cairo-dev
      - openjdk-17
      - openjdk-17-default-jvm
      - libxmu-dev
      - pango-dev
      - perl
      - tiff-dev
      - tzdata
      - glibc-iconv
      - glibc-dev
      - libjpeg-turbo-dev
      - libice-dev
      - libgcc
      - libx11-dev
      - libgomp

pipeline:
  - uses: fetch
    with:
      expected-sha256: 8dd0bf24f1023c6f618c3b317383d291b4a494f40d73b983ac22ffea99e4ba99
      uri: https://cran.r-project.org/src/base/R-4/R-${{package.version}}.tar.gz

  - runs: |
      r_cv_have_curl728=y \
      ./configure \
        --prefix=/usr \
        --sysconfdir=/etc/R \
        --localstatedir=/var \
        --mandir=/usr/share/man \
        --libdir=/usr/lib \
        rdocdir=/usr/share/doc/R \
        rincludedir=/usr/include/R \
        rsharedir=/usr/share/R \
        --disable-nls \
        --enable-R-shlib \
        --enable-java \
        --with-blas=openblas \
        --with-cairo \
        --with-ICU \
        --with-jpeglib \
        --with-lapack \
        --with-libpng \
        --with-libtiff \
        --with-x \
        --with-tcltk

  - uses: autoconf/make

  - runs: |
      make -C src/nmath/standalone

  - uses: autoconf/make-install

  - runs: |
      _rhome="usr/lib/R"
      ldpath="/$_rhome/lib"
      contextdir="${{targets.contextdir}}/$_rhome"

      cd src/nmath/standalone
      make DESTDIR="${{targets.contextdir}}" install
      cd ../../../

      # Fixup R wrapper script (taken from Arch).
      rm "$contextdir"/bin/R
      ln -sf /usr/bin/R "$contextdir"/bin/R

      # Remove some useless files (COPYING is duplicated, it will be
      # in -doc, don't worry).
      rm "$contextdir"/COPYING "$contextdir"/SVN-REVISION

      mkdir -p "${{targets.contextdir}}"/etc/R

      # R apparently ignores --sysconfdir, so we must manually move configs
      # to /etc/R and make symlinks.
      cd "$contextdir"/etc
      for f in *; do
        mv "$f" "${{targets.contextdir}}"/etc/R/ && ln -sf /etc/R/$f $f
      done

  - uses: strip

subpackages:
  - name: R-mathlib
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib
          mv "${{targets.contextdir}}"/usr/lib/libRmath.so* "${{targets.contextdir}}"/usr/lib

  - name: R-dev
    pipeline:
      - uses: split/dev
    description: R dev

  - name: R-doc
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/share/doc/
          mv "${{targets.contextdir}}"/usr/share/doc/* "${{targets.contextdir}}"/usr/share/doc/
    description: R manpages

update:
  release-monitor:
    identifier: 4150
