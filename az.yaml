package:
  name: az
  version: 2.67.0
  epoch: 0
  description: Azure CLI
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - openssf-compiler-options
      - py3-pip
      - python3
      - python3-dev
      - py3-wheel

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Azure/azure-cli/
      tag: azure-cli-${{package.version}}
      expected-commit: 0494144e9222fce4728adc76410c8210530dc279

  - name: Python Build
    runs: |
      cd src/azure-cli
      python setup.py bdist_wheel
      cd ../azure-cli-core
      python setup.py bdist_wheel
      cd ../..
      
      # Setup the virtualenv
      python -m venv .venv --system-site-packages
      source .venv/bin/activate
      # Bump pip to patch a CVE
      pip install --no-cache-dir --prefix=/usr --root=${{targets.contextdir}} --ignore-installed --upgrade pip==23.3.2 setuptools==70.0.0 certifi==2024.07.04 requests==2.32.0 urllib3==1.26.19 idna==3.7

      pip install --no-compile src/azure-cli/dist/*.whl src/azure-cli-core/dist/*.whl

      mkdir -p ${{targets.destdir}}/usr/share/az
      mv .venv ${{targets.destdir}}/usr/share/az/

      # edit the venv paths
      sed -i "s|/home/build|/usr/share|g" ${{targets.destdir}}/usr/share/${{package.name}}/.venv/bin/*

      # Include system site-packages
      sed -i "s|include-system-site-packages = false|include-system-site-packages = true|g" ${{targets.destdir}}/usr/share/${{package.name}}/.venv/pyvenv.cfg

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      ln -s /usr/share/az/.venv/bin/az ${{targets.destdir}}/usr/bin/az

  - uses: strip

update:
  enabled: true
  github:
    identifier: Azure/azure-cli
    strip-prefix: azure-cli-

test:
  pipeline:
    - runs: |
        az --version
        az -h
