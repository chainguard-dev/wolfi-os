package:
  name: nexus-public
  version: 3.71.0.06
  epoch: 0
  description: A Kubernetes Operator based on the Operator SDK for installing and managing Keycloak.
  copyright:
    - license: Apache-2.0

var-transforms:
  - from: ${{package.version}}
    match: '(\d+\.\d+\.\d+)\.(\d{2})'
    replace: '$1-$2'
    to: mangled-package-version

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - nodejs-20
      - openjdk-17
      - openjdk-17-default-jvm
      - yarn
  environment:
    JAVA_HOME: /usr/lib/jvm/java-17-openjdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/sonatype/nexus-public
      tag: release-${{vars.mangled-package-version}}
      expected-commit: 5709fc75914918b0a70c27da227e5e6b3404ffb9

  - runs: |
      yarn cache clean --all
      LANG=en_US.UTF-8 LANGUAGE=en ./mvnw clean install -DskipTests
      mkdir -p "${{targets.contextdir}}"/opt/sonatype
      mkdir -p "${{targets.contextdir}}"/opt/sonatype/nexus
      mkdir -p "${{targets.contextdir}}"/opt/sonatype/sonatype-work/
      mkdir -p "${{targets.contextdir}}"/nexus-data
      unzip -d ./target ./target/nexus-base-template-*-SNAPSHOT-bundle.tar.gz
      mv ./target/nexus-base-template-*-SNAPSHOT/ "${{targets.contextdir}}"/opt/sonatype/nexus/
      ln -s "${{targets.contextdir}}"/nexus-data "${{targets.contextdir}}"/opt/sonatype/sonatype-work/nexus3

      sed -i '/^-Xms/d;/^-Xmx/d;/^-XX:MaxDirectMemorySize/d' "${{targets.contextdir}}"/opt/sonatype/nexus/bin/nexus.vmoptions

      SONATYPE_DIR="${{targets.contextdir}}"/opt/sonatype
      echo "#!/bin/bash" >> ${SONATYPE_DIR}/start-nexus-repository-manager.sh \
      && echo "cd /opt/sonatype/nexus" >> ${SONATYPE_DIR}/start-nexus-repository-manager.sh \
      && echo "exec ./bin/nexus run" >> ${SONATYPE_DIR}/start-nexus-repository-manager.sh \
      && chmod a+x ${SONATYPE_DIR}/start-nexus-repository-manager.sh \
      && sed -e '/^nexus-context/ s:$:${NEXUS_CONTEXT}:' -i ${NEXUS_HOME}/etc/nexus-default.properties

# test:
#   pipeline:
#     - runs: |
#         # # This only runs in k8s but make sure it errors correctly
#         # java -Djava.util.logging.manager=org.jboss.logmanager.LogManager -jar /usr/share/java/quarkus-app/quarkus-run.jar 2>&1 | grep "Couldn't retrieve the currently connected namespace"
update:
  enabled: true
  github:
    identifier: sonatype/nexus-public
    strip-prefix: release-
