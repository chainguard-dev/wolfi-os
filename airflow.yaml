package:
  name: airflow
  version: 2.9.1
  epoch: 2
  description: Platform to programmatically author, schedule, and monitor workflows
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - gcc
      - glibc-dev
      - py3-pip
      - python3
      - python3-dev
      - wolfi-base
      - yarn
      - nodejs

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apache/airflow
      tag: ${{package.version}}
      expected-commit: 2d53c1089f78d8d1416f51af60e1e0354781c661

  - runs: |
      # requires EPOCH to be later that 1980
      export SOURCE_DATE_EPOCH=315532800
      python -m venv venv
      source venv/bin/activate

      pip install build
      python -m build --wheel
      pip install dist/*.whl

  - working-directory: venv/lib/python3.12/site-packages/airflow/www
    runs: |
      yarn install --frozen-lockfile
      yarn run build
      rm -rf node_modules __pycache__

  - runs: |
      mkdir -p ${{targets.destdir}}/opt/airflow

      venv/bin/airflow config list --defaults > ${{targets.destdir}}/"airflow.cfg"
      mv venv ${{targets.destdir}}/opt/airflow

      sed -i "s|/home/build|/opt/airflow|g" ${{targets.destdir}}/opt/airflow/venv/bin/*
      cp airflow/config_templates/default_webserver_config.py ${{targets.destdir}}/
      cp scripts/docker/entrypoint_prod.sh ${{targets.destdir}}/entrypoint
      cp scripts/docker/clean-logs.sh ${{targets.destdir}}/clean-logs
      cp scripts/docker/airflow-scheduler-autorestart.sh ${{targets.destdir}}/airflow-scheduler-autorestart

      mkdir -p ${{targets.destdir}}/scripts/docker
      cp -r scripts/docker/* ${{targets.destdir}}/scripts/docker

update:
  enabled: true
  ignore-regex-patterns:
    - 'rc\d+$'
    - 'helm-chart*'
  github:
    identifier: apache/airflow
    tag-filter:

test:
  environment:
    contents:
      packages:
        - wolfi-base
        - airflow
  pipeline:
    - runs: |
        export PATH=/opt/airflow/venv/bin:$PATH
        airflow version
