package:
  name: wildfly
  version: 35.0.0.Final
  epoch: 0
  description: WildFly Application Server
  copyright:
    - license: Apache-2.0
  dependencies:
    provides:
      - wildfly=${{package.full-version}}

data:
  - name: openjdk-versions
    items:
      # 21: "openjdk-21"
      17: "openjdk-17"

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl
      - openjdk-17
      # - openjdk-21
      - maven

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/wildfly/wildfly
      tag: ${{package.version}}
      expected-commit: 325c418fa1ab0a9f5eee7da5f351c78df268e53a

  - runs: |
      export JAVA_HOME="/usr/lib/jvm/java-17-openjdk"
      ./mvnw install -DskipTests -Dskip.docs

subpackages:
  - range: openjdk-versions
    name: ${{package.name}}-${{range.value}}
    dependencies:
      runtime:
        - ${{range.value}}-default-jvm
    pipeline:
      - runs: |
          export JAVA_HOME="/usr/lib/jvm/java-${{range.key}}-openjdk"

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly
          cp build/target/wildfly-35.0.0.Final/LICENSE.txt ${{targets.contextdir}}/usr/share/wildfly/
          cp build/target/wildfly-35.0.0.Final/README.txt ${{targets.contextdir}}/usr/share/wildfly/

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/bin
          cp -r build/target/wildfly-35.0.0.Final/bin/* ${{targets.contextdir}}/usr/share/wildfly/bin/

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/domain
          cp -r build/target/wildfly-35.0.0.Final/domain/configuration ${{targets.contextdir}}/usr/share/wildfly/domain/

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/domain/log
          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/domain/tmp
          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/domain/data
          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/domain/servers

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/standalone
          cp -r build/target/wildfly-35.0.0.Final/standalone/configuration ${{targets.contextdir}}/usr/share/wildfly/standalone/
          cp -r build/target/wildfly-35.0.0.Final/standalone/deployments ${{targets.contextdir}}/usr/share/wildfly/standalone/
          cp -r build/target/wildfly-35.0.0.Final/standalone/lib ${{targets.contextdir}}/usr/share/wildfly/standalone/

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/standalone/log
          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/standalone/tmp

          mkdir -p ${{targets.contextdir}}/usr/share/wildfly/modules
          cp -r build/target/wildfly-35.0.0.Final/modules/* ${{targets.contextdir}}/usr/share/wildfly/modules/

          cp build/target/wildfly-35.0.0.Final/jboss-modules.jar ${{targets.contextdir}}/usr/share/wildfly/
      - name: Test Wildfly with OpenJDK ${{range.key}}
        uses: test/daemon-check-output
        with:
          setup: |
            #!/bin/sh -ex
            rm -rf /usr/share/wildfly/*
            mkdir -p /usr/share/wildfly
            cp -rf ${{targets.contextdir}}/usr/share/wildfly/* /usr/share/wildfly
          start: |
            sh -c "
            export JAVA_HOME=/usr/lib/jvm/java-${{range.key}}-openjdk
            mvn archetype:generate \
              -DarchetypeGroupId=org.wildfly.archetype \
              -DarchetypeArtifactId=wildfly-getting-started-archetype \
              -DgroupId=com.example \
              -DartifactId=getting-started \
              -Dversion=1.0-SNAPSHOT \
              -DinteractiveMode=false
            cd getting-started
            mvn clean wildfly:dev -X &
            sleep 60
            "
          timeout: 60
          expected_output: |
            Starting deployment of "ROOT.war"
            Deployed "ROOT.war" 
          post: |
            url=http://localhost:8080
            response=$(curl -s -o /dev/null -w "%{http_code}" "$url")
            if [ "$response" -ne 200 ]; then
              echo "WildFly management interface is not responding correctly"
              exit 1
            fi
            html=$(curl -s "$url")
            if [ -z "$html" ]; then
              echo "Got empty HTML content from $url"
              exit 1
            fi
            echo "$html" | grep -q "Welcome to WildFly Application Server" || {
              echo "response from $url did not contain \"Welcome to WildFly Application Server\""
              exit 1
            }
            echo "WildFly management interface is up"

update:
  enabled: true
  ignore-regex-patterns:
    - '-M\d+$'
  github:
    identifier: wildfly/wildfly
    use-tag: true
    tag-filter: .Final
    strip-suffix: .Final
    