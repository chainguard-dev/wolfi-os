package:
  name: filebeat
  version: 8.11.3
  epoch: 0
  description: Filebeat is a lightweight shipper for forwarding and centralizing log data.
  copyright:
    - license: Apache License Version 2.0

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - git
      - mage
      - python3
      - go

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/elastic/beats.git
      tag: v${{package.version}}
      expected-commit: bfdd9fb0a3c4eeeacf5a5bc2110164a177e4cb08

  # - uses: go/bump
  #   with:
  #     deps: go.temporal.io/server@v1.20.0 golang.org/x/net@v0.17.0 google.golang.org/grpc@v1.56.3

  - runs: |
      cd filebeat
      export BEATS=filebeat
      export PACKAGES="docker"
      export PLATFORMS="linux/amd64"
      make release
      install -Dm755 build/package/filebeat-oss/filebeat-oss-linux-amd64.docker/docker-build/beat/filebeat ${{targets.destdir}}/usr/share/filebeat

  - uses: strip

# subpackages:
#   - name: tctl-compat
#     description: Compat package for tctl
#     pipeline:
#       - runs: |
#           mkdir -p "${{targets.subpkgdir}}"/usr/local/bin
#           ln -s /usr/bin/tctl "${{targets.subpkgdir}}"/usr/local/bin

#   - name: tctl-authorization-plugin
#     description: "sub package for tctl-authorization-plugin"
#     pipeline:
#       - runs: |
#           # CVE-2023-3485
#           go get go.temporal.io/server@v1.20.0

#           # CVE-2023-3978, CVE-2023-39325, CVE-2023-44487
#           go get golang.org/x/net@v0.17.0

#           # GHSA-m425-mq94-257g
#           go get google.golang.org/grpc@v1.56.3

#           go mod tidy

#           make build

#           mkdir -p "${{targets.subpkgdir}}"/usr/bin
#           install -Dm755 tctl-authorization-plugin ${{targets.contextdir}}/usr/bin/tctl-authorization-plugin
#       - uses: strip

#   - name: tctl-authorization-plugin-compat
#     description: "Compat package for tctl-authorization-plugin"
#     pipeline:
#       - runs: |
#           mkdir -p "${{targets.subpkgdir}}"/usr/local/bin
#           ln -s /usr/bin/tctl-authorization-plugin "${{targets.subpkgdir}}"/usr/local/bin
#       - uses: strip

update:
  enabled: true
  github:
    identifier: elastic/beats
    strip-prefix: v
