package:
  name: zaproxy
  version: 2.14.0
  epoch: 0
  description: The ZAP core project
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - Xvfb
      - autoconf
      - automake
      - aws-cli
      - bash # some helper scripts use bash
      - curl
      - gcc
      - git
      - make
      - net-tools
      - openbox
      - openjdk-11-default-jvm
      - py3-pyyaml
      - py3-zaproxy
      - python3
      - unzip
      - wget
      - x11vnc
      - xmlstarlet
      - xterm

environment:
  contents:
    packages:
      - bash
      - busybox
      - ca-certificates-bundle
      - curl
      - openjdk-11-default-jvm
      - wget
      - xmlstarlet

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/zaproxy/zaproxy
      tag: v${{package.version}}
      expected-commit: ebddb3e91eeb52017ced2b080f14e958043f91cf

  - runs: |
      export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
      wget -qO- https://raw.githubusercontent.com/zaproxy/zap-admin/master/ZapVersions.xml | xmlstarlet sel -t -v //url |grep -i Linux | wget --content-disposition -i - -O - | tar zxv && \
      mv ZAP*/* .
      ls -latr
      ./zap.sh -cmd -silent -addonupdate
      mkdir -p "${{targets.destdir}}"/home/zap
      mkdir -p "${{targets.destdir}}"/zap/plugin
      mkdir -p "${{targets.destdir}}"/home/zap/.ZAP/policies
      mkdir -p "${{targets.destdir}}"/root/.ZAP/policies
      mkdir -p "${{targets.destdir}}"/home/zap/.ZAP_D/scripts/

      mv /root/.ZAP/plugin/*.zap "${{targets.destdir}}"/zap/plugin/

      WEBSWING_VERSION=23.2.2
      curl -s -L  "https://dev.webswing.org/files/public/webswing-examples-eval-${WEBSWING_VERSION}-distribution.zip" > webswing.zip
      unzip webswing.zip

      mkdir -p "${{targets.destdir}}"/zap/webswing
      mv webswing-* "${{targets.destdir}}"/zap/webswing

      cp ./docker/zap* "${{targets.destdir}}"/zap/
      cp ./docker/CHANGELOG.md "${{targets.destdir}}"/zap/
      cp ./docker/webswing.config "${{targets.destdir}}"/zap/webswing/
      cp ./docker/webswing.properties "${{targets.destdir}}"/zap/webswing/
      cp -r ./docker/policies "${{targets.destdir}}"/home/zap/.ZAP/policies/
      cp -r ./docker/policies "${{targets.destdir}}"/root/.ZAP/policies/
      cp -r ./docker/scripts "${{targets.destdir}}"/home/zap/.ZAP_D/scripts/
      cp ./docker/.xinitrc "${{targets.destdir}}"/home/zap/

      mkdir -p "${{targets.destdir}}"/zap/.vnc
      echo "zap2docker-stable" > "${{targets.destdir}}"/zap/container
      chmod a+x "${{targets.destdir}}"/home/zap/.xinitrc

update:
  enabled: true
  github:
    identifier: zaproxy/zaproxy
    strip-prefix: v
