package:
  name: debezium
  version: 3.0.1
  epoch: 0
  description: Debezium is a change data capture (CDC) platform that achieves its durability, reliability, and fault tolerance qualities by reusing Kafka and Kafka Connect.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - debezium-core
      - openjdk-21-default-jvm

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl
      - maven
      - openjdk-21
      - openjdk-21-default-jvm
  environment:
    JAVA_HOME: /usr/lib/jvm/java-21-openjdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/debezium/debezium
      tag: v${{package.version}}.Final
      expected-commit: 1b40156ddb661a46ee3ff1d041aa12bc5d8c02a9

data:
  - name: targets
    items:
      connector-jdbc: connector-jdbc
      connector-mariadb: connector-mariadb
      connector-mongodb: connector-mongodb
      connector-mysql: connector-mysql
      connector-postgres: connector-postgres
      connector-sqlserver: connector-sqlserver
      # connector-oracle: connector-oracle

subpackages:
  - name: ${{package.name}}-core
    description: Debezium Core
    pipeline:
      - name: Build
        runs: |
          ./mvnw clean install -B -ntp -f debezium-core/pom.xml -T$(nproc)C \
            -am \
            -DskipTests=true \
            -DskipITs=true \
            -Dcheckstyle.skip=true \
            -Dformat.skip=true \
            -Drevapi.skip \
            -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
            -Dmaven.wagon.http.pool=false \
            -Dmaven.wagon.httpconnectionManager.ttlSeconds=120 \
            --no-transfer-progress \
            --fail-fast
      - name: Extract JARs
        runs: |
          mkdir -p "${{targets.contextdir}}"/usr/share/java/debezium/${{package.name}}
          tar -zxf target/${{package.name}}-${{package.version}}.Final-plugin.tar.gz --strip-components=1 -C ${{targets.contextdir}}/usr/share/java/debezium/${{package.name}}
          install -Dm644 target/${{package.name}}-${{package.version}}.Final.jar -t ${{targets.contextdir}}/usr/share/java/debezium/${{package.name}}/
      - uses: strip

  - range: targets
    name: ${{package.name}}-${{range.key}}
    description: ${{range.key}}
    dependencies:
      runtime:
        - ${{package.name}}-core
    pipeline:
      - name: Build
        runs: |
          ./mvnw clean install -B -pl debezium-${{range.value}} -am -T$(nproc)C \
            -Passembly \
            -Dcheckstyle.skip=true \
            -Dformat.skip=true \
            -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
            -Dmaven.wagon.http.pool=false \
            -Dmaven.wagon.httpconnectionManager.ttlSeconds=120 \
            -Ddebezium.test.records.waittime=10 \
            -DfailFlakyTests=false \
            -Ddebezium.test.mongo.replica.primary.startup.timeout.seconds=120 \
            -DskipITs=true -DskipTests=true -Dcheckstyle.skip=true -Dformat.skip=true -Drevapi.skip \
            --no-transfer-progress \
            --fail-fast
      - name: Extract JARs
        runs: |
          component=${{package.name}}-${{range.key}}
          mkdir -p "${{targets.contextdir}}"/usr/share/java/${{package.name}}/${component}
          tar -zxf ${component}/target/${component}-${{package.version}}.Final-plugin.tar.gz --strip-components=1 -C ${{targets.contextdir}}/usr/share/java/${{package.name}}/${component}
          cp -avR ${component}/target/${component}-${{package.version}}.Final.jar ${{targets.contextdir}}/usr/share/java/${{package.name}}/${component}/${component}.jar
      - uses: strip

  - name: ${{package.name}}-connectors-all
    dependencies:
      runtime:
        - ${{package.name}}-connector-jdbc
        - ${{package.name}}-connector-mariadb
        - ${{package.name}}-connector-mongodb
        - ${{package.name}}-connector-mysql
        - ${{package.name}}-connector-postgres
        - ${{package.name}}-connector-sqlserver
        # - ${{package.name}}-connector-oracle
        - ${{package.name}}-connector-db2
        - ${{package.name}}-connector-ibmi
        - ${{package.name}}-connector-informix
        - ${{package.name}}-connector-spanner
        - ${{package.name}}-connector-vitess
    pipeline:
      - runs: mkdir -p ${{targets.contextdir}}
    description: Virtual package that installs all Debezium connectors

update:
  enabled: true
  github:
    identifier: debezium/debezium
    use-tag: true
    tag-filter: .Final

test:
  environment:
    environment:
      JAVA_HOME: /usr/lib/jvm/java-21-openjdk
  pipeline:
    - runs: echo
