package:
  name: kafka-ui
  version: 0.7.1
  epoch: 0
  description: Open-Source Web UI for Apache Kafka Management
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - openjdk-17-jre

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - libstdc++ # needed for node and pnpm that maven runs locally during the build...
      - openjdk-17-default-jdk
      - pombump
      - wolfi-base
  environment:
    LANG: en_US.UTF-8
    JAVA_HOME: /usr/lib/jvm/default-jvm

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/provectus/kafka-ui
      tag: v${{package.version}}
      expected-commit: 56fa824510d8a35b08e3b42bf6625c846e2ed5a0

  - runs: |
      pombump pom.xml --patches-file ./patches.yaml --properties-file ./properties.yaml > pom.xml.new
      diff -w pom.xml pom.xml.new > pomdiffs || true
      cat pomdiffs
      mv pom.xml.new pom.xml

  - runs: |
      ./mvnw -B -ntp versions:set -DnewVersion="${{package.version}}"
      ./mvnw -B -V -ntp clean package -Pprod -DskipTests -Ddocker.skip=true
      ./mvnw -q -Dexec.executable=echo -Dexec.args='${{package.version}}' --non-recursive exec:exec

      mkdir -p "${{targets.contextdir}}"/usr/lib/kafka-ui
      cp kafka-ui-api/target/kafka-ui-api-"${{package.version}}".jar "${{targets.contextdir}}"/usr/lib/kafka-ui/

subpackages:
  - name: kafka-ui-compat
    pipeline:
      - runs: |
          ln -s /usr/lib/kafka-ui/kafka-ui-api-"${{package.version}}".jar /kafka-ui-api-"${{package.version}}".jar

test:
  environment:
    contents:
      packages:
        - curl
        - openjdk-17-default-jvm
  pipeline:
    - runs: |
        /usr/lib/jvm/default-jvm/bin/java --add-opens java.rmi/javax.rmi.ssl=ALL-UNNAMED -jar /usr/lib/kafka-ui/kafka-ui-api-${{package.version}}.jar&
        sleep 10 # wait for things to start up
        curl -s localhost:8080 |grep 'UI for Apache Kafka'

update:
  enabled: true
  github:
    identifier: provectus/kafka-ui
    strip-prefix: v
    tag-filter: v
    use-tag: true
