package:
  name: julia-1.10
  version: 1.10.0
  epoch: 0
  description: The Julia Programming Language
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - llvm16-dev
      - perl
      - python3
      - pcre2-dev
      - libatomic
      - gfortran
      - perl
      - wget
      - m4
      - cmake

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/JuliaLang/julia.git
      tag: v${{package.version}}
      expected-commit: 3120989f39bb7ef7863c4aab8ab1227cf71eec66

  - runs: sed -i '/^const debug_output/c\const debug_output = stdout' contrib/generate_precompile.jl
  #- runs: sed -i '/^const PARALLEL_PRECOMPILATION/c\const PARALLEL_PRECOMPILATION = false' contrib/generate_precompile.jl

  # - runs: |
  #     cat > Make.user <<-EOF
  #       prefix=/usr
  #       libexecdir=/usr/lib
  #       sysconfdir=/etc
  #       DESTDIR=${{targets.destdir}}
  #       LIBBLAS=-lopenblas
  #       LIBBLASNAME=libopenblas
  #       LIBLAPACK=-lopenblas
  #       LIBLAPACKNAME=libopenblas
  #       LLVM_CONFIG=/usr/lib/llvm16/bin/llvm-config
  #       LLVM_VER=16
  #       NO_GIT=1
  #       USE_LLVM_SHLIB=1
  #       USE_SYSTEM_ARPACK=1
  #       USE_SYSTEM_BLAS=1
  #       USE_SYSTEM_CURL=1
  #       USE_SYSTEM_DSFMT=1
  #       USE_SYSTEM_FFTW=1
  #       USE_SYSTEM_GMP=1
  #       USE_SYSTEM_LAPACK=1
  #       USE_SYSTEM_LIBBLASTRAMPOLINE=1
  #       USE_SYSTEM_LIBGIT2=1
  #       USE_SYSTEM_LIBM=1
  #       USE_SYSTEM_LIBSSH2=1
  #       USE_SYSTEM_LIBUNWIND=1
  #       USE_SYSTEM_LIBUV=0
  #       USE_SYSTEM_LLVM=1
  #       USE_SYSTEM_MBEDTLS=1
  #       USE_SYSTEM_MPFR=1
  #       USE_SYSTEM_OPENLIBM=1
  #       USE_SYSTEM_OPENSPECFUN=1
  #       USE_SYSTEM_PATCHELF=1
  #       USE_SYSTEM_PCRE=1
  #       USE_SYSTEM_SUITESPARSE=1
  #       USE_SYSTEM_UTF8PROC=1
  #       VERBOSE=1
  #     EOF

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/lib/julia
      mv ${{targets.destdir}}/home/build/julia*/* ${{targets.destdir}}/usr/lib/julia/
      ln -s /usr/lib/julia/bin/julia ${{targets.destdir}}/usr/bin/julia

  - uses: strip

test:
  environment:
    contents:
      packages:
        - busybox
        - apk-tools
  pipeline:
    - name: Basic Hello World Test
      runs: |
        #!/bin/bash

        # Run the Julia program and capture the output
        output=$(julia hello_world.jl)

        # Define the expected output
        expected="Hello, World!"

        # Compare the actual output with the expected output
        if [ "$output" = "$expected" ]; then
            echo "Test Passed: Output matches expected"
        else
            echo "Test Failed: Output does not match expected"
            echo "Expected: '$expected'"
            echo "Got: '$output'"
            exit 1
        fi

update:
  enabled: true
  github:
    identifier: JuliaLang/julia
    strip-prefix: v
    tag-filter-prefix: v1.10.
