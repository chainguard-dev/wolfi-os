# Generated from https://git.alpinelinux.org/aports/plain/main/bluez/APKBUILD
package:
  name: bluez
  version: "5.79"
  epoch: 1
  description: Tools for the Bluetooth protocol stack
  copyright:
    - license: GPL-2.0-or-later AND BSD-2-Clause AND MIT

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - ca-certificates-bundle
      - dbus
      - dbus-dev
      - ell-dev
      - glib-dev
      - icu-dev
      - json-c-dev
      - libical-dev
      - libtool
      - linux-headers
      - openssf-compiler-options
      - py3-docutils
      - py3-pygments
      - python3
      - readline-dev
      - systemd-dev

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 0845b8f6ef2ac004b1c953cf4fe4ca3458cd8e36
      repository: https://github.com/bluez/bluez.git
      tag: ${{package.version}}
      cherry-picks: |
        # https://github.com/wolfi-dev/os/issues/31026
        master/b1fd409960001a77cda2a09ecc00147ebd9c3667: build: Leave config files writable for owner

  - uses: autoconf/configure
    with:
      opts: |
        --disable-systemd \
        --enable-library \
        --enable-deprecated \
        --enable-hid2hci \
        --enable-mesh \
        --enable-sixaxis \
        --with-dbusconfdir=/usr/share

  - uses: autoconf/make

  - runs: |
      make DESTDIR="${{targets.destdir}}" install install-pluginLTLIBRARIES
      install -Dm755 test/simple-agent "${{targets.destdir}}"/usr/bin/bluez-simple-agent
      install -Dm755 tools/btmgmt -t "${{targets.destdir}}"/usr/bin/
      install -Dm755 attrib/gatttool -t "${{targets.destdir}}"/usr/bin/

      install -Dm644 obexd/src/org.bluez.obex.service \
        "${{targets.destdir}}"/usr/share/dbus-1/services/org.bluez.obex.service

  - uses: strip

subpackages:
  - name: bluez-dbg
    pipeline:
      - uses: split/debug

  - name: bluez-doc
    pipeline:
      - uses: split/manpages
    description: bluez manpages

  - name: bluez-btmgmt
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/btmgmt ${{targets.subpkgdir}}/usr/bin
    test:
      pipeline:
        - runs: |
            btmgmt --version

  - name: bluez-btmon
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/btmon ${{targets.subpkgdir}}/usr/bin
    test:
      pipeline:
        - runs: |
            btmon --version
            btmon --help

  - name: bluez-cups
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib
          mv ${{targets.destdir}}/usr/lib/cups ${{targets.subpkgdir}}/usr/lib

  - name: bluez-meshctl
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/bin/meshctl ${{targets.subpkgdir}}/usr/bin
    test:
      pipeline:
        - runs: |
            meshctl --version

  - name: bluez-dev
    pipeline:
      - uses: split/dev
    description: bluez dev
    test:
      pipeline:
        - uses: test/pkgconf

update:
  enabled: true
  github:
    identifier: bluez/bluez

test:
  pipeline:
    # AUTOGENERATED
    - runs: |
        bluemoon --version
        bluetoothctl --version
        btattach --version
        ciptool --version
        gatttool --help
        hciconfig --version
        hcidump --version
        hcitool --version
        hex2hcd --version
        mesh-cfgclient --version
        mesh-cfgtest --version
        mpris-proxy --version
        rfcomm --version
        sdptool --help
        bluemoon --help
        btattach --help
        ciptool --help
        hciconfig --help
        hcidump --help
        hcitool --help
        hex2hcd --help
        mesh-cfgtest --help
        mpris-proxy --help
        rfcomm --help
