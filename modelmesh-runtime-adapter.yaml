package:
  name: modelmesh-runtime-adapter
  version: 0.12.0
  epoch: 0
  description: Unified runtime-adapter package of the sidecar containers which run in the modelmesh pods
  dependencies:
    runtime:
      - py3-importlib-metadata   # we have this
      - py3-numpy                # we have this
      - py3-tensorflow-core      # this includes tensorboard, tensorboard-data-server. Does not include tensorflow-estimator because that was deprecated.
      - py3-zipp                 # we have this

      - py3-cachetools           # to build
      - py3-google-auth          # to build
      - py3-google-auth-oauthlib # to build
      - py3-oauthlib             # to build
      - py3-pyasn1               # to build
      - py3-pyasn1-modules       # to build
      - py3-requests-oauthlib    # to build
      - py3-rsa                  # to build

      # cachetools                   5.3.3  #dont have 3.10
      # google-auth                  2.30.0 #dont have 3.10
      # google-auth-oauthlib         1.0.0  #dont have 3.10
      # oauthlib                     3.2.2  #dont have 3.10
      # pyasn1                       0.6.0  #dont have 3.10
      # pyasn1_modules               0.4.0  #dont have 3.10
      # requests-oauthlib            2.0.0  #dont have 3.10
      # rsa                          4.9    #dont have 3.10

data:
  - name: binaries
    items:
      mlserver-adapter: model-mesh-mlserver-adapter
      ovms-adapter: model-mesh-ovms-adapter
      torchserve-adapter: model-mesh-torchserve-adapter
      triton-adapter: model-mesh-triton-adapter
      puller: model-serving-puller

# pipeline:
#   - uses: fetch
#     with:
#       uri: "https://files.pythonhosted.org/packages/b1/de/021c1d407befb505791764ad2cbd56ceaaa53a746baed01d2e2143f05f18/tensorboard-2.18.0-py3-none-any.whl"
#       expected-sha256: "107ca4821745f73e2aefa02c50ff70a9b694f39f790b11e6f682f7d326745eab"
#       extract: false
#   - uses: fetch
#     with:
#       uri: "https://files.pythonhosted.org/packages/7a/13/e503968fefabd4c6b2650af21e110aa8466fe21432cd7c43a84577a89438/tensorboard_data_server-0.7.2-py3-none-any.whl"
#       expected-sha256: "7e0610d205889588983836ec05dc098e80f97b7e7bbff7e994ebb78f578d0ddb"
#       extract: false
#   - uses: fetch
#     with:
#       uri: "https://files.pythonhosted.org/packages/b6/c8/2f823c8958d5342eafc6dd3e922f0cc4fcf8c2e0460284cc462dae3b60a0/tensorflow_estimator-2.15.0-py2.py3-none-any.whl"
#       expected-sha256: "aedf21eec7fb2dc91150fc91a1ce12bc44dbb72278a08b58e79ff87c9e28f153"
#       extract: false
#   - uses: git-checkout
#     with:
#       repository: https://github.com/kserve/modelmesh-runtime-adapter
#       expected-commit: 5d0c9a008cce30b2b3839874c9f1f2ca8ddc38de
#       tag: v${{package.version}}

subpackages:
  - range: binaries
    name: "modelmesh-runtime-adapter-${{range.key}}"
    description: "${{range.key}} binary for modelmesh-runtime-adapter"
    pipeline:
      - uses: go/build
        with:
          output: ${{range.key}}
          packages: ./${{range.value}}
          ldflags: -s

  - name: "modelmesh-runtime-adapter-compat"
    description: "compat package to place binaries in location expected by upstream helm chart"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/opt/app"
          ln -sf /usr/bin/mlserver-adapter ${{targets.subpkgdir}}/opt/app/mlserver-adapter
          ln -sf /usr/bin/ovms-adapter ${{targets.subpkgdir}}/opt/app/ovms-adapter
          ln -sf /usr/bin/torchserve-adapter ${{targets.subpkgdir}}/opt/app/torchserve-adapter
          ln -sf /usr/bin/triton-adapter ${{targets.subpkgdir}}/opt/app/triton-adapter
          ln -sf /usr/bin/puller ${{targets.subpkgdir}}/opt/app/puller

test:
  environment:
    contents:
      packages:
        - ${{package.name}}-mlserver-adapter
        - ${{package.name}}-ovms-adapter
        - ${{package.name}}-torchserve-adapter
        - ${{package.name}}-triton-adapter
        - ${{package.name}}-puller
        - ${{package.name}}-compat
  pipeline:
    - name: TEST
      runs: |
        export CONTAINER_MEM_REQ_BYTES=1
        torchserve-adapter 2>&1 | grep -q 'TorchServe runtime adapter started'
        ovms-adapter 2>&1 | grep -q 'OVMS Runtime started'
        triton-adapter 2>&1 | grep -q 'Triton runtime adapter started'
        mlserver-adapter 2>&1 | grep -q 'MLServer runtime adapter started'
        puller 2>&1 | grep -q 'starting clean up of cached clients'

update:
  enabled: true
  github:
    identifier: kserve/modelmesh-runtime-adapter
    strip-prefix: v
