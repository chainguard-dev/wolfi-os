package:
  name: modelmesh-runtime-adapter
  version: 0.12.0
  epoch: 0
  description: Unified runtime-adapter package of the sidecar containers which run in the modelmesh pods

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/kserve/modelmesh-runtime-adapter.git
      expected-commit: 5d0c9a008cce30b2b3839874c9f1f2ca8ddc38de
      tag: v${{package.version}}
  - uses: go/build
    with:
      output: mlserver-adapter
      packages: ./model-mesh-mlserver-adapter
      ldflags: -s -w
  - uses: strip

  - uses: go/build
    with:
      output: ovms-adapter
      packages: ./model-mesh-ovms-adapter
      ldflags: -s -w
  - uses: strip

  - uses: go/build
    with:
      output: torchserve-adapter
      packages: ./model-mesh-torchserve-adapter
      ldflags: -s -w
  - uses: strip

  - uses: go/build
    with:
      output: triton-adapter
      packages: ./model-mesh-triton-adapter
      ldflags: -s -w
  - uses: strip

  - uses: go/build
    with:
      output: puller
      packages: ./model-serving-puller
      ldflags: -s -w
  - uses: strip

  - name: TEST
    runs: |
      export CONTAINER_MEM_REQ_BYTES=1
      if ! (mlserver-adapter | grep "MLServer runtime adapter started"); then
        echo "mlserver-adapter failed"
        exit 1
      fi &
      if ! (ovms-adapter | grep "OVMS Runtime started"); then
        echo "ovms-adapter failed"
        exit 1
      fi &
      if ! (torchserve-adapter | grep "TorchServe runtime adapter started" ); then
        echo "torchserve-adapter failed"
        exit 1
      fi &
      if ! (triton-adapter | grep "Triton runtime adapter started"); then
        echo "triton-adapter failed"
        exit 1
      fi &
      if ! (puller | grep "starting clean up of cached clients"); then
        echo "puller failed"
        exit 1
      fi &
      echo "All tests passed"
