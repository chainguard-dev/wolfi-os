package:
  name: ruby-3.4
  version: 3.4.0
  epoch: 0
  description: "the Ruby programming language"
  copyright:
    - license: Ruby
    - license: BSD-2-Clause
  dependencies:
    provides:
      - ruby=${{package.full-version}}
      - ruby3.4-benchmark
      - ruby3.4-cgi
      - ruby3.4-date
      - ruby3.4-delegate
      - ruby3.4-did_you_mean
      - ruby3.4-digest
      - ruby3.4-english
      - ruby3.4-erb
      - ruby3.4-error_highlight
      - ruby3.4-etc
      - ruby3.4-fcntl
      - ruby3.4-fiddle
      - ruby3.4-fileutils
      - ruby3.4-find
      - ruby3.4-forwardable
      - ruby3.4-io-console
      - ruby3.4-io-nonblock
      - ruby3.4-io-wait
      - ruby3.4-ipaddr
      - ruby3.4-irb
      - ruby3.4-json
      - ruby3.4-logger
      - ruby3.4-net-http
      - ruby3.4-net-protocol
      - ruby3.4-open-uri
      - ruby3.4-open3
      - ruby3.4-openssl
      - ruby3.4-optparse
      - ruby3.4-ostruct
      - ruby3.4-pathname
      - ruby3.4-pp
      - ruby3.4-prettyprint
      - ruby3.4-prism
      - ruby3.4-pstore
      - ruby3.4-psych
      - ruby3.4-rdoc
      - ruby3.4-readline
      - ruby3.4-reline
      - ruby3.4-resolv
      - ruby3.4-ruby2_keywords
      - ruby3.4-securerandom
      - ruby3.4-set
      - ruby3.4-shellwords
      - ruby3.4-singleton
      - ruby3.4-stringio
      - ruby3.4-strscan
      - ruby3.4-syntax_suggest
      - ruby3.4-tempfile
      - ruby3.4-time
      - ruby3.4-timeout
      - ruby3.4-tmpdir
      - ruby3.4-tsort
      - ruby3.4-un
      - ruby3.4-uri
      - ruby3.4-weakref
      - ruby3.4-win32ole
      - ruby3.4-yaml
      - ruby3.4-zlib
    runtime:
      - glibc
      - gmp
      - libgcc
      - openssl
      - yaml
      - zlib

environment:
  contents:
    packages:
      - autoconf
      - build-base
      - busybox
      - coreutils
      - gdbm-dev
      - glibc-dev
      - gmp-dev
      - graphviz
      - libffi-dev
      - libxcrypt-dev
      - linux-headers
      - openssf-compiler-options
      - openssl-dev
      - pkgconf
      - readline-dev
      - ruby-3.4-bootstrap
      - rust
      - tk-dev
      - yaml-dev
      - zlib-dev

vars:
  prefix: /usr

var-transforms:
  - from: ${{package.version}}
    match: \.
    replace: _
    to: underscore-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/ruby/ruby
      tag: v${{vars.underscore-package-version}}_preview2
      expected-commit: 32c733f57bb91e22972319ee63eac9521d954ebc

  - name: Generate and Configure
    runs: |
      ./autogen.sh
      ./configure \
         --prefix=${{vars.prefix}} \
         --sysconfdir=/etc \
         --enable-shared \
         --disable-rpath \
         --enable-pthread \
         --enable-mkmf-verbose \
         --enable-yjit

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

  - runs: |
      set -x
      RUBYWILD="$(echo ${{package.version}} | cut -d. -f-2).*"
      RUBYDIR=${{targets.destdir}}${{vars.prefix}}/lib/ruby/$RUBYWILD rm -rf ${RUBYDIR}/bundler rm ${RUBYDIR}/bundler.rb
      GEMDIR=${{targets.destdir}}${{vars.prefix}}/lib/ruby/gems/$RUBYWILD rm -rf ${GEMDIR}/gems/bundler-* rm ${GEMDIR}/specifications/default/bundler-*.gemspec
      rm -rf ${{targets.destdir}}/usr/bin/bundle \ ${{targets.destdir}}/usr/bin/bundler
      rm -rf ${{targets.destdir}}/usr/lib/ruby/${{package.version}}*/bundler*

  - runs: |
      set -x

      rm -rf --verbose ${{targets.destdir}}/usr/lib/ruby/gems/${{package.version}}*/cache
      while read -r gem ; do
        echo $gem
        rm -rf --verbose ${{targets.destdir}}/usr/lib/ruby/gems/${{package.version}}*/gems/${gem}*
        rm -rf --verbose ${{targets.destdir}}/usr/lib/ruby/specifications/${gem}-*.gemspec
        rm -rf --verbose ${{targets.destdir}}/usr/lib/ruby/gems/${{package.version}}*/specifications/${gem}*.gemspec
        rm -rf --verbose ${{targets.destdir}}/usr/lib/ruby/gems/${{package.version}}*/specifications/default/${gem}*.gemspec

      done < standard_gems
      while read -r bin ; do
         echo $bin
         rm -rf --verbose ${{targets.destdir}}/usr/bin/${bin}
         rm -rf --verbose ${{targets.destdir}}/usr/bin/${bin}.lock
         rm -rf --verbose ${{targets.destdir}}/usr/share/man/man1/${bin}.1
      done < standard_gems_bins

subpackages:
  - name: "ruby-3.4-doc"
    description: "ruby documentation"
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/share
          mv "${{targets.destdir}}"/usr/share/doc "${{targets.subpkgdir}}"/usr/share/
          mv "${{targets.destdir}}"/usr/share/ri "${{targets.subpkgdir}}"/usr/share/

  - name: "ruby-3.4-dev"
    description: "ruby development headers"
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/pkgconf

update:
  enabled: true
  version-transform:
    - match: "_"
      replace: .
  github:
    identifier: ruby/ruby
    strip-prefix: v
    use-tag: true
    tag-filter-prefix: v3_4_

test:
  pipeline:
    - runs: |
        ruby --version | grep ${{package.version}}

        cat <<EOF >> /tmp/hello.rb
        puts("Hello Wolfi!")
        EOF

        ruby /tmp/hello.rb
        ruby --help
    - name: Test bundled binaries are absent
      runs: |
        ls /usr/bin | grep 'racc|rake|rbi|erb|gem' || exit 0 && exit 1
