package:
  name: openjdk17
  version: 17.0.5
  epoch: 0
  description: "Oracle OpenJDK 17"
  # s390x: no openjdk17
  # oracle dropped support for 32 bit
  target-architecture:
    - all !s390x !x86 !armhf !armv7 !riscv64
  copyright:
    - paths:
      - "*"
      attestation: TODO
      license: MIT
  dependencies:
    runtime:
  # scriptlets:
  #   trigger:
  #     paths:
  #       - /bin
  #       - /sbin
  #       - /usr/bin
  #       - /usr/sbin
  #     script: |
  #       #!/bin/busybox sh
  #       /bin/busybox --install -s
# secfixes:
#   1.35.0-r3:
#     - CVE-2022-28391
#     - CVE-2022-30065

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/bootstrap/stage3
    keyring:
      - https://packages.wolfi.dev/bootstrap/stage3/wolfi-signing.rsa.pub
    packages:
      - bash
      - ca-certificates-bundle
      - build-base
      - automake
      - autoconf
      - bash
      - gawk
      - grep
      - make
      - openjdk16-jdk
      - zip
      - alsa-lib-dev
      - cups-dev
      - elfutils-dev
      - fontconfig-dev
      - freetype-dev
      - giflib-dev
      - lcms2-dev
      - libffi-dev
      - libjpeg-turbo-dev
      - libx11-dev
      - libxext-dev
      - libxrandr-dev
      - libxrender-dev
      - libxt-dev
      - libxtst-dev
      - linux-headers
      - zlib-dev

pipeline:
  - uses: fetch
    with:
      uri: https://github.com/openjdk/jdk17u/archive/jdk-${{package.version}}-ga.tar.gz
      # expected-sha256: faeeb244c35a348a334f4a59e44626ee870fb07b6884d68c10ae8bc19f83a694
  - uses: fetch
    with:
      uri: https://github.com/google/googletest/archive/release-1.8.1.tar.gz
      # expected-sha256: faeeb244c35a348a334f4a59e44626ee870fb07b6884d68c10ae8bc19f83a694
  
  # CFLAGS, CXXFLAGS and LDFLAGS are ignored as shown by a warning
  # in the output of ./configure unless used like such:
  #  --with-extra-cflags="$CFLAGS"
  #  --with-extra-cxxflags="$CXXFLAGS"
  #  --with-extra-ldflags="$LDFLAGS"
  # See also paragraph "Configure Control Variables" from "common/doc/building.md"
  # shellcheck disable=2097 disable=2098
  - runs: |
      if [ $_run_jtreg -ne 0 ]; then
        _with_jtreg="--with-jtreg=/usr/share/java/jtreg"
      else
        _with_jtreg="--with-jtreg=no"
      fi

      CFLAGS='' CXXFLAGS='' LDFLAGS='' \
        bash ./configure \
        --build=$CBUILD \
        --host=$CHOST \
        --target=$CTARGET \
        --prefix="$_java_home" \
        --sysconfdir=/etc \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --localstatedir=/var \
        --with-extra-cflags="$CFLAGS" \
        --with-extra-cxxflags="$CXXFLAGS" \
        --with-extra-ldflags="$LDFLAGS" \
        --with-zlib=system \
        --with-libjpeg=system \
        --with-giflib=system \
        --with-libpng=system \
        --with-lcms=system \
        --with-jobs=${JOBS:-4} \
        --with-test-jobs=${JOBS:-4} \
        --with-native-debug-symbols=none \
        --with-gtest=../googletest-release-1.8.1 \
        $_with_jtreg \
        --disable-warnings-as-errors \
        --disable-precompiled-headers \
        --enable-dtrace=no \
        --with-jvm-variants=server \
        --with-debug-level=release \
        --with-version-pre= \
        --with-version-opt="alpine-r$pkgrel" \
        --with-version-build="${pkgver##*p}" \
        --with-vendor-name="Alpine" \
        --with-vendor-url="https://chainguard.dev/" \
        --with-vendor-bug-url="https://github.com/wolfi-dev/os/issues" \
        --with-vendor-vm-bug-url="https://github.com/wolfi-dev/os/issues"
  # - runs: |
  #     MAKEFLAGS='' make jdk-image
  - uses: autoconf/make
  - uses: autoconf/make-install
  - runs: |
      make DESTDIR="$${{targets.destdir}}" install
  - uses: strip

# subpackages:
#   - name: "bash-doc"
#     description: "bash documentation"
#     pipeline:
#       - uses: split/manpages
#       - uses: split/infodir
#       - runs: |
#           mkdir -p "${{targets.subpkgdir}}"/usr/share
#           mv "${{targets.destdir}}"/usr/share/doc "${{targets.subpkgdir}}"/usr/share/
#   - name: "bash-dev"
#     description: "bash development headers"
#     pipeline:
#       - uses: split/dev
#       - runs: |
#           mkdir -p "${{targets.subpkgdir}}"/bin
#           mv "${{targets.destdir}}"/bin/bashbug "${{targets.subpkgdir}}"/bin/
#           mkdir -p "${{targets.subpkgdir}}"/usr/lib/bash
#           mv "${{targets.destdir}}"/usr/lib/bash/Makefile* "${{targets.subpkgdir}}"/usr/lib/bash/  
