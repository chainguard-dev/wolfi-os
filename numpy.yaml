package:
  name: numpy
  version: 1.26.4
  epoch: 2
  description: "The fundamental package for scientific computing with Python."
  copyright:
    - license: BSD-3-Clause

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - cython
      - gfortran
      - git
      - meson
      - openblas-dev
      - py3-gpep517
      - py3-packaging
      - py3-pip
      - py3-setuptools
      - py3-wheel
      - python3
      - python3-dev
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/numpy/numpy
      tag: v${{package.version}}
      expected-commit: 9815c16f449e12915ef35a8255329ba26dacd5c0
      recurse-submodules: true

  - runs: |
      # Eventually this should become a default pipeline
      # Use most up to date wheel method for building this thing
      pip wheel --no-deps .
      # Install it with better .dist-info data
      pip install --no-compile --no-deps --prefix=/usr --root="${{targets.destdir}}" ./*.whl
      # Accelerate startup time with the fastest .pyc cache files
      python3 -m compileall -f --invalidation-mode=unchecked-hash -r100 "${{targets.destdir}}"

  - uses: strip

subpackages:
  - name: f2py
    description: "f2py for numpy (for python3)"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/bin
          mv "${{targets.destdir}}"/usr/bin/f2py* "${{targets.subpkgdir}}"/usr/bin
    dependencies:
      runtime:
        - python3-dev
        - numpy
  - name: numpy-whl
    pipeline:
      - runs: |
          # Eventually this should be split wheels pipeline
          # ... but should this be a single wheel; or a collection of
          # wheels that this package needs
          # also want to build these wheels for all supported python versions
          # but the pythons are still not co-installable
          mkdir -p "${{targets.subpkgdir}}"/usr/share/python-wheels
          cp *.whl "${{targets.subpkgdir}}"/usr/share/python-wheels
  - name: numpy-static
    pipeline:
      - runs: |
          # ideally generate this for all pythons, but they are still
          # not co-installable
          # This version of numpy is preinstalled with all the dependencies
          # As if it is 'static', with all the deps
          # .... however this is not a great example as numpy doesn't have any deps
          pip install --no-compile --prefix=/usr --root="${{targets.subpkgdir}}" ./*.whl
          # Accelerate startup time with the fastest .pyc cache files
          python3 -m compileall -f --invalidation-mode=unchecked-hash -r100 "${{targets.subpkgdir}}"

update:
  enabled: true
  github:
    identifier: numpy/numpy
    # There are some v2 pre-releases
    tag-filter: v1
    strip-prefix: v
    strip-suffix: .dev0
