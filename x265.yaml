package:
  name: x265
  version: 3.5
  epoch: 0
  description: Open Source H265/HEVC video encoder
  copyright:
    - license: GPL-2.0-or-later

environment:
  contents:
    packages:
      - ca-certificates-bundle
      - busybox
      - automake
      - autoconf
      - samurai
      - cmake
      - nasm
      - numactl-dev
      - build-base

pipeline:
  - uses: fetch
    with:
      expected-sha256: e70a3335cacacbba0b3a20ec6fecd6783932288ebc8163ad74bcc9606477cae8
      uri: https://bitbucket.org/multicoreware/x265_git/downloads/x265_${{package.version}}.tar.gz

  - runs: |
      case "${{build.arch}}" in
        x86) cmake_opts="-DENABLE_ASSEMBLY=OFF";;
        aarch64) cmake_opts="-DENABLE_ASSEMBLY=OFF";;
        ppc*) cmake_opts="-DENABLE_ALTIVEC=OFF -DCPU_POWER8=OFF";;
        *) cmake_opts="-DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy";;
      esac

      cmake -B build-12 -S source -G Ninja -Wno-dev \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DHIGH_BIT_DEPTH=TRUE \
        -DMAIN12=TRUE \
        -DEXPORT_C_API=FALSE \
        -DENABLE_CLI=FALSE \
        -DENABLE_SHARED=FALSE \
        -DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy \
        $cmake_opts
      cmake --build build-12

      cmake -B build-10 -S source -G Ninja -Wno-dev \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DHIGH_BIT_DEPTH=TRUE \
        -DEXPORT_C_API=FALSE \
        -DENABLE_CLI=FALSE \
        -DENABLE_SHARED=FALSE \
        $([ "$CARCH" = "aarch64" ] && echo "-DENABLE_ASSEMBLY=OFF") \
        -DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy \
        $cmake_opts
      cmake --build build-10

      ln -s ../build-10/libx265.a build/libx265_main10.a
      ln -s ../build-12/libx265.a build/libx265_main12.a

      cmake -B build -S source -G Ninja -Wno-dev \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DEXTRA_LIB='x265_main10.a;x265_main12.a' \
        -DEXTRA_LINK_FLAGS='-L.' \
        -DLINKED_10BIT=TRUE \
        -DLINKED_12BIT=TRUE \
        -DCMAKE_ASM_NASM_FLAGS=-w-macro-params-legacy \
        $cmake_opts
      cmake --build build

  - runs: |
      DESTDIR="${{targets.destdir}}" cmake --install build

  - uses: strip

subpackages:
  - name: x265-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - x265
    description: x265 dev

  - name: x265-lib
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/bin
          mv ${{targets.destdir}}/usr/lib/lib*.so.* ${{targets.subpkgdir}}/usr/lib
    description: x265 lib

update:
  enabled: true
  release-monitor:
    identifier: 7275
