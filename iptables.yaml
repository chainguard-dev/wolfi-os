package:
  name: iptables
  version: 1.8.10
  epoch: 5
  description: Linux kernel firewall, NAT and packet mangling tools
  copyright:
    - license: GPL-2.0-or-later
  dependencies:
    replaces:
      - ip6tables
    runtime:
      - xtables

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - bison
      - build-base
      - busybox
      - ca-certificates-bundle
      - flex
      - libmnl-dev
      - libnftnl-dev
      - libtool
      - linux-headers
      - pkgconf-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://git.netfilter.org/iptables
      tag: v${{package.version}}
      expected-commit: 9b9d9a1b0c9ec85d406d7475961068628074ddcf
      depth: "-1"

  - runs: |
      ./autogen.sh

  - runs: |
      export CFLAGS="$CFLAGS -D_GNU_SOURCE"
      ./configure \
        --build="$CBUILD" \
        --host="$CHOST" \
        --prefix=/usr \
        --mandir=/usr/share/man \
        --sbindir=/sbin \
        --sysconfdir=/etc \
        --without-kernel \
        --enable-devel \
        --enable-libipq \
        --enable-shared

      # do not use rpath
      sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
      sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      mkdir -p "${{targets.destdir}}"/usr/include/libiptc

      install -m644 include/iptables.h include/ip6tables.h "${{targets.destdir}}"/usr/include/
      install include/libiptc/*.h "${{targets.destdir}}"/usr/include/libiptc/

      install -D -m644 iptables.confd "${{targets.destdir}}"/etc/conf.d/iptables
      install -D -m644 ebtables.confd "${{targets.destdir}}"/etc/conf.d/ebtables

subpackages:
  - name: iptables-doc
    description: iptables documentation
    pipeline:
      - uses: split/manpages

  - name: iptables-dev
    description: iptables development files
    pipeline:
      - uses: split/dev

  - name: ip6tables
    checks:
      disabled:
        - empty
    dependencies:
      runtime:
        - iptables

  - name: xtables
    description: xtables multi call binaries and libraries
    dependencies:
      replaces:
        - iptables
        - ip6tables
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}
          cd ${{targets.subpkgdir}}
          mv ${{targets.destdir}}/etc .
          mkdir -p sbin usr var/lib/iptables var/lib/ip6tables etc/iptables
          mv ${{targets.destdir}}/sbin/xtables-* ${{targets.subpkgdir}}/sbin/
          mv ${{targets.destdir}}/usr/lib ${{targets.subpkgdir}}/usr/

update:
  enabled: true
  release-monitor:
    identifier: 1394
