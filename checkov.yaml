package:
  name: checkov
  version: 3.2.262
  epoch: 0
  description: "static code and composition analysis tool for IaC"
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - python-3

environment:
  contents:
    packages:
      - build-base
      - ca-certificates-bundle
      - glibc
      - linux-headers
      - posix-libc-utils
      - python-3
      - wolfi-base
      - wolfi-baselayout

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/bridgecrewio/checkov
      tag: ${{package.version}}
      expected-commit: c02ca1c093de2117141585ad747c6df1be880e5e
      destination: checkov

  - runs: |
      mkdir -p "${{targets.destdir}}"/usr/share/app/checkov && mkdir -p "${{targets.destdir}}"/usr/bin
      mv checkov/* "${{targets.destdir}}"/usr/share/app/checkov
      cd "${{targets.destdir}}"/usr/share/app/checkov
      python3 -m venv .venv
      .venv/bin/python3 -m pip install --upgrade pip
      .venv/bin/pip install .
      .venv/bin/pip install --upgrade --force-reinstall setuptools
      CHECKOV_PYTHON_PATH="#!/usr/share/app/checkov/.venv/bin/python3"
      sed -i "1s,.*,$CHECKOV_PYTHON_PATH," checkov/main.py
      rm -rf tests *_tests setup.py
      ln -s /usr/share/app/checkov/checkov/main.py "${{targets.destdir}}"/usr/bin/checkov

  - uses: strip

update:
  enabled: true
  manual: false
  github:
    identifier: bridgecrewio/checkov
    use-tag: true

test:
  pipeline:
    - runs: |
        checkov --version
        checkov --help
