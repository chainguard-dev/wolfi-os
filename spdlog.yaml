package:
  name: spdlog
  version: 1.15.0
  epoch: 1
  description: Fast C++ logging library.
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - fmt-dev
      - make

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 8e5613379f5140fefb0b60412fbf1f5406e7c7f8
      repository: https://github.com/gabime/spdlog
      tag: v${{package.version}}
      cherry-picks: |
        v1.x/276ee5f5c0eb13626bd367b006ace5eae9526d8a: fix: update to_string_view function for fmt 11.1 (#3301)

  - uses: cmake/configure
    with:
      opts: |
        -DCMAKE_BUILD_TYPE=None \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DSPDLOG_BUILD_BENCH=OFF \
        -DSPDLOG_BUILD_TESTS=OFF \
        -DSPDLOG_SANITIZE_ADDRESS=OFF \
        -DSPDLOG_FMT_EXTERNAL=ON \
        -DSPDLOG_BUILD_SHARED=ON \
        -DSPDLOG_BUILD_EXAMPLE=OFF \
        # to verify if this is the right flag
        # -DSPDLOG_FMT_EXTERNAL_HO=ON \

  - uses: cmake/build

  - uses: cmake/install

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    pipeline:
      - uses: split/dev

test:
  environment:
    contents:
      packages:
        - posix-libc-utils
        - spdlog-dev
  pipeline:
    - name: "Verify spdlog headers and library installation"
      runs: |
        # Check for the main spdlog header file
        echo "Checking if spdlog headers are installed..."
        if [ -f /usr/include/spdlog/spdlog.h ]; then
          echo "Found spdlog header: /usr/include/spdlog/spdlog.h"
        else
          echo "Error: spdlog header not found!"
          exit 1
        fi

        # Check for the spdlog library file
        echo "Checking if spdlog library is installed..."
        if [ -f /usr/lib/libspdlog.so ]; then
          echo "Found spdlog library: /usr/lib/libspdlog.so"
        else
          echo "Error: spdlog library not found!"
          exit 1
        fi
    - name: "Verify spdlog library linkability"
      runs: |
        echo "Checking if spdlog library links correctly..."
        if ldd /usr/lib/libspdlog.so | grep -q "fmt"; then
          echo "spdlog library links correctly with required dependencies."
        else
          echo "Error: spdlog library failed to link with required dependencies."
          exit 1
        fi

update:
  enabled: true
  github:
    identifier: gabime/spdlog
    strip-prefix: v
    tag-filter: v
