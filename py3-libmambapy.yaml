package:
  name: py3-libmambapy
  version: 2.0.5
  epoch: 0
  description: Cross-Platform Package Manager
  copyright:
    - license: BSD-3-Clause
  dependencies:
    provider-priority: 0

vars:
  pypi-package: libmambapy
  import: libmambapy

data:
  - name: py-versions
    items:
      3.10: "310"
      3.11: "311"
      3.12: "312"
      3.13: "300"

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - ccache
      - clang
      - cli11
      - cmake
      - curl-dev
      - doctest
      - fmt-dev
      - libarchive-dev
      - libmamba-dev=${{package.version}}
      - libsolv-dev
      - make
      - nlohmann-json
      - openssf-compiler-options
      - openssl-dev
      - py3-supported-distro
      - py3-supported-pip
      - py3-supported-pybind11
      - py3-supported-python-dev
      - py3-supported-scikit-build
      - py3-supported-wheel
      - reproc
      - reproc++
      - samurai
      - simdjson-dev
      - spdlog-dev
      - tl-expected
      - yaml-cpp-dev
      - zstd-dev
      - zstd-static
  environment:
    # /home/build/libmambapy/src/libmambapy/bindings/legacy.cpp:557:47: warning: 'mamba::expected_t<std::__cxx11::basic_string<char> > mamba::SubdirData::cache_path() const' is deprecated: since version 2.0 use ``valid_solv_cache`` or ``valid_json_cache`` instead [-Wdeprecated-declarations]
    CXXFLAGS: -fPIC -Wno-error=deprecated-declarations

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 4cbb3f7de08b75a5bffd50fd6b4bb79f0291dd42
      repository: https://github.com/mamba-org/mamba
      tag: libmambapy-${{package.version}}

  - uses: cmake/configure
    with:
      opts: |
        -DBUILD_LIBMAMBA="OFF" \
        -DBUILD_LIBMAMBAPY="ON" \
        -DBUILD_MICROMAMBA="OFF" \
        -DBUILD_MAMBA_PACKAGE="OFF" \
        -DCMAKE_BUILD_TYPE=Release

subpackages:
  - range: py-versions
    name: py${{range.key}}-${{vars.pypi-package}}
    dependencies:
      runtime:
        - libmamba=${{package.version}}
      provides:
        - py3-${{vars.pypi-package}}
      provider-priority: ${{range.value}}
    pipeline:
      - uses: py/pip-build-install
        with:
          python: python${{range.key}}
        working-directory: ./libmambapy
    test:
      pipeline:
        - uses: python/import
          with:
            python: python${{range.key}}
            import: ${{vars.import}}

  - name: py3-supported-${{vars.pypi-package}}
    description: meta package providing ${{vars.pypi-package}} for supported python versions
    dependencies:
      runtime:
        - py3.10-${{vars.pypi-package}}
        - py3.11-${{vars.pypi-package}}
        - py3.12-${{vars.pypi-package}}
        - py3.13-${{vars.pypi-package}}
    test:
      pipeline:
        - uses: python/import
          with:
            python: python3.10
            import: ${{vars.import}}
        - uses: python/import
          with:
            python: python3.11
            import: ${{vars.import}}
        - uses: python/import
          with:
            python: python3.12
            import: ${{vars.import}}
        - uses: python/import
          with:
            python: python3.13
            import: ${{vars.import}}

  - name: libmamba-dev
    pipeline:
      - uses: split/dev

update:
  enabled: true
  ignore-regex-patterns:
    - .*alpha.*
    - .*beta.*
    - .*rc.*
  github:
    identifier: mamba-org/mamba
    tag-filter-prefix: libmambapy-
    strip-prefix: libmambapy-
    use-tag: true

test:
  environment:
    contents:
      packages:
        - python3
  pipeline:
    - runs: |
        python3 -c "import libmambapy; print(libmambapy.Context)"
