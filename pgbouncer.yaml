package:
  name: pgbouncer
  version: 1.21.0
  epoch: 1
  description: lightweight connection pooler for PostgreSQL
  copyright:
    - license: ISC

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - build-base
      - busybox
      - c-ares-dev
      - ca-certificates-bundle
      - libevent-dev
      - libtool
      - openssl-dev
      - pkgconf-dev

var-transforms:
  - from: ${{package.version}}
    match: \.
    replace: _
    to: mangled-package-version

pipeline:
  # Use fetch instead of git-checkout, if we get the repo from git we need to generate docs
  # and the docs require pandoc which requires haskell
  - uses: fetch
    with:
      uri: https://github.com/pgbouncer/pgbouncer/releases/download/pgbouncer_${{vars.mangled-package-version}}/pgbouncer-${{package.version}}.tar.gz
      expected-sha256: 7e1dd620c8d85a8490aff25061d5055d7aef9cf3e8bfe2d9e7719b8ee59114e2

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: pgbouncer-doc
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/share/doc/
          mv "${{targets.destdir}}"/usr/share/doc/pgbouncer "${{targets.subpkgdir}}"/usr/share/doc
    description: pgbouncer manpages

  - name: ${{package.name}}-bitnami-compat
    description: "compat package with bitnami/pgbouncer image"
    dependencies:
      runtime:
        - libbsd-dev
        # - libaudit1  #https://pkgs.alpinelinux.org/contents?branch=edge&name=audit-libs&arch=x86&repo=main
        - libbsd-dev
        - c-ares-dev
        - libcap-ng-dev
        - libedit-dev
        - libevent-dev
        - libffi-dev
        - libgcc
        - gmp-dev
        - gnutls-dev
        - icu-dev
        - libidn-dev
        - openldap-dev
        - xz-dev
        - libmd-dev
        - nettle-dev
        - p11-kit-dev
        - linux-pam-dev
        - cyrus-sasl-dev
        - openssl-dev
        - libstdc++-dev
        - libtasn1-dev
        - ncurses-dev
        - libunistring-dev
        - util-linux-dev
        - libxml2-dev
        - libxslt-dev
        - glibc-locale-en
        - procps
        - zlib-dev
        - wait-for-port
    pipeline:
      - uses: bitnami/compat
        with:
          image: pgbouncer
          version-path: 1/debian-12
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/opt/bitnami/pgbouncer
          mkdir -p "${{targets.subpkgdir}}"/opt/bitnami/pgbouncer/logs
          mkdir -p "${{targets.subpkgdir}}"/opt/bitnami/pgbouncer/tmp
          mkdir -p "${{targets.subpkgdir}}"/bitnami/pgbouncer/conf
          mkdir -p ${{targets.subpkgdir}}/opt/bitnami/common/lib
          mkdir -p ${{targets.subpkgdir}}/docker-entrypoint-initdb.d

          # sed all the scripts to use absolute path in the build environment
          find . -iname "*.sh" -exec sed 's#/opt/bitnami#${{targets.subpkgdir}}/opt/bitnami#g' -i {} \;

          # this script does some magic with env vars, templates, etc. etc.
          # it is easier to run it than figure out everything that it touches

          # I don't think that this is necessary, but it is in the original script
          # it gives an error 'line 46: locale-gen: command not found'
          # ${{targets.subpkgdir}}/opt/bitnami/scripts/locales/add-extra-locales.sh
          ${{targets.subpkgdir}}/opt/bitnami/scripts/pgbouncer/postunpack.sh

          # un-sed everything back to absolute /opt/bitnami prefix
          find ${{targets.subpkgdir}}/opt/bitnami -type f -exec sed 's#${{targets.subpkgdir}}##g' -i {} \;

update:
  # Doesn't work with var transforms
  enabled: false
  manual: true
  github:
    identifier: pgbouncer/pgbouncer
    strip-prefix: pgbouncer_
    tag-filter: pgbouncer_
