# source is gitlab so we can't use github updates to get expected commit
# let's still auto create the PR, it will fail as expected commit will be wrong
# however it will be easy to fix
#nolint:git-checkout-must-use-github-updates
package:
  name: gitlab-cng
  version: 17.1.0
  epoch: 0
  description: Cloud Native container images per component of GitLab
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - busybox

pipeline:
  - uses: git-checkout
    with:
      repository: https://gitlab.com/gitlab-org/build/CNG.git
      tag: v${{package.version}}
      expected-commit: a07a1449f7f51cf45dc384e82d6d5742fb0b1832

data:
  # Used to create all of the *-scripts subpackages from the CNG repo.
  - name: scripts
    items:
      cfssl-self-sign: ./cfssl-self-sign
      container-registry: ./gitlab-container-registry
      exporter: ./gitlab-exporter
      geo-logcursor: ./gitlab-geo-logcursor
      gitaly: ./gitaly
      mailroom: ./gitlab-mailroom
      pages: ./gitlab-pages
      rails: ./gitlab-rails
      shell: ./gitlab-shell
      sidekiq: ./gitlab-sidekiq
      toolbox: ./gitlab-toolbox
      webservice: ./gitlab-webservice
      workhorse: ./gitlab-workhorse

subpackages:
  - range: scripts
    name: "${{package.name}}-${{range.key}}-scripts"
    pipeline:
      - runs: |
          cd ${{range.value}}
          for x in $(find scripts/ -type f); do
            mkdir -p ${{targets.subpkgdir}}/$(dirname $x)
            cp -r $x ${{targets.subpkgdir}}/$x
          done

  - name: "${{package.name}}-base"
    pipeline:
      - runs: |
          cd ./gitlab-base
          for x in $(find scripts/ -type f); do
            mkdir -p ${{targets.subpkgdir}}/$(dirname $x)
            cp -r $x ${{targets.subpkgdir}}/$x
          done
    dependencies:
      runtime:
        - bash
        - busybox
        - ca-certificates-bundle
        - curl
        - gitlab-logger
        - gomplate
        - procps
        - xtail

  - name: "${{package.name}}-certificates"
    pipeline:
      - runs: |
          cd ./certificates
          mkdir -p ${{targets.subpkgdir}}/scripts
          cp scripts/bundle-certificates ${{targets.subpkgdir}}/scripts/entrypoint.sh
    dependencies:
      runtime:
        - ca-certificates
        - gitlab-cng-base
    test:
      pipeline:
        - name: Test entrypoint script
          runs: |
            # creating a fake certificate
            touch /etc/ssl/certs/test-cert1.pem

            # running the entrypoint script
            # ls -l
            # ls melange-out
            # ls -l ~/scripts
            # ls -l ${{targets.subpkgdir}}/scripts
            ./scripts/entrypoint.sh

            # if the script runs without error, the test certificate should be purged
            if [ -f /etc/ssl/certs/test-cert1.pem ]; then
              echo "test-cert1.pem should have been purged, but it still exists"
              exit 1
            fi

update:
  enabled: true
  release-monitor:
    identifier: 10037
