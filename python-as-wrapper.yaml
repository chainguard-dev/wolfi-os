package:
  name: python-as-wrapper
  version: 0.1.0
  epoch: 0
  description: Shell script wrapper to exec python3.XX
  copyright:
    - license: Apache-2.0

# In a "normal" installation of python, 'python3' is a symlink
# to 'pythonX.Y' where X.Y is Major.Minor (3.13).  In that scenario,
# if caller invokes 'python3', then when python reads its sys.executable,
# the executable is 'python3'.
#
# That value of sys.executable is "sticky" and finds its way into shbangs that
# are installed with 'pip install' or other places.
#
# In the vast majority of places, we do not want shebang with
# /usr/bin/python3 because at runtime:
#  * python3 might be a symlink to another python version
#  * python3 may not exist at all - with only python3.XX installed.
#
# This wrapper will cause the scripts generated by 'python3 -m pip install pkg'
# to be generated with a shbang of /usr/bin/python3.Y instead of /usr/bin/python3.
#
# Note: None of these packages are intended for production use.
# They are intended to be used to accomodate package build systems
# That invoke 'python3' or 'python'.
data:
  - name: py-versions
    items:
      3.10: '310'
      3.11: '311'
      3.12: '312'
      3.13: '313'
  - name: python-as-names
    items:
      python: PYTHON_AS
      python3: PYTHON3_AS

environment:
  contents:
    packages:
      - busybox

pipeline:
  - runs: |
      chmod 755 write-strict write-env
      chmod 755 test-python3-as-env test-python3-as-wrapper

subpackages:
  - range: py-versions
    name: python3-as-${{range.key}}
    description: provides /usr/bin/python3 that execs python${{range.key}}
    dependencies:
      runtime:
        - python-${{range.key}}-base
    pipeline:
      - runs: |
          ./write-strict "python${{range.key}}" ${{targets.contextdir}}/usr/bin/python3
    test:
      environment:
        contents:
          packages:
            - python3-as-test
      pipeline:
        - name: validate wrapper 'python3' for ${{range.key}}
          runs: |
            python3 /usr/bin/test-python3-as-wrapper \
              python3 test-python3-as-wrapper ${{range.key}}

  - range: py-versions
    name: python-as-${{range.key}}
    description: provides /usr/bin/python that execs python${{range.key}}
    dependencies:
      runtime:
        - python-${{range.key}}-base
    pipeline:
      - runs: |
          ./write-strict "python${{range.key}}" ${{targets.contextdir}}/usr/bin/python
    test:
      environment:
        contents:
          packages:
            - python3-as-test
      pipeline:
        - name: validate wrapper 'python' for ${{range.key}}
          runs: |
            python /usr/bin/test-python3-as-wrapper \
              python test-python3-as-wrapper ${{range.key}}

  - range: python-as-names
    name: ${{range.key}}-as-env
    description: provides /usr/bin/${{range.key}} that execs env var ${{range.value}}
    pipeline:
      - runs: |
          ./write-env "${{range.value}}" ${{targets.contextdir}}/usr/bin/${{range.key}}
    test:
      environment:
        contents:
          packages:
            - python3-as-test
      pipeline:
        - name: validate wrapper '${{range.key}}'
          runs: |
            test-python3-as-env /usr/bin/${{range.key}} ${{range.value}} ${{range.key}}

  - name: python3-as-test
    description: provides the tests for this package
    pipeline:
      - runs: |
          install -D -m755 "-t${{targets.contextdir}}/usr/bin" test-*

update:
  enabled: false
  exclude-reason: No source to watch for the new versions - this is the source.
