package:
  name: sdp-k8s-injector
  version: 1.0.13
  epoch: 0
  description: "SDP Client for Kubernetes"
  copyright:
    - license: MIT

environment:
  contents:
    packages:
      - rust
      - wolfi-base
      - busybox
      - ca-certificates-bundle
      - build-base
      - openssl-dev

data:
  - name: other_binaries
    items:
      sdp-device-id-service: "sdp-device-id-service"
      sdp-identity-service: "sdp-identity-service"

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/appgate/sdp-k8s-injector
      tag: v${{package.version}}-sdp-k8s-injector-crd
      expected-commit: 3aa2f8516df85aec2f12ae3af6d560dc268c9790

  - name: Configure and build
    runs: |
      cargo build --release
      mkdir -p ${{targets.contextdir}}/usr/bin

      # move the executable binaries to the contextdir
      for f in target/release/sdp-*; do
        if [ -x "$f" ] && [ -f "$f" ] ; then
          mv "$f" ${{targets.contextdir}}/usr/bin/
        fi
      done

subpackages:
  - range: other_binaries
    name: ${{range.key}}
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/bin/
          mv ${{targets.contextdir}}/usr/bin/${{range.key}} ${{targets.contextdir}}/usr/bin/

update:
  enabled: true
  github:
    identifier: appgate/sdp-k8s-injector
    strip-prefix: v
    strip-suffix: -sdp-k8s-injector-crd
