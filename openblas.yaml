package:
  name: openblas
  version: 0.3.23
  epoch: 0
  description: fast BSD-licensed BLAS based on gotoBLAS2, with LAPACK
  copyright:
    - license: BSD-3-Clause

environment:
  contents:
    packages:
      - ca-certificates-bundle
      - busybox
      - perl
      - build-base
      - linux-headers

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/xianyi/openblas
      tag: v${{package.version}}
      expected-commit: 394a9fbafe9010b76a2615c562204277a956eb52

  - uses: patch
    with:
      patches: blas-lapack.patch

  - runs: |
      builddir=$(pwd)
      cd ..
      # ILP64 is not supported on aarch64 (https://github.com/xianyi/OpenBLAS/issues/956)
      _ilp64=false
      if [ "${{build.arch}}" = "x86_64" ]; then
      	_ilp64=true
      fi

      # USE_OPENMP=0: see GCC bug 60035
      # NO_AFFINITY: don't expect to work on musl, also breaks R and not
      #              recommended for Julia
      # NO_STATIC: this is absolutely massive and not used anywhere in aports
      _flags="
      	MAJOR_VERSION=3
      	NO_AFFINITY=1
      	NO_STATIC=1
      	USE_OPENMP=0
      	PREFIX=/usr
      	"
      case "${{build.arch}}" in
      *64|s390x)
      	# match kernel's CONFIG_NR_CPUS
      	_flags="$_flags NUM_THREADS=256"
      	;;
      *)
      esac

      case "${{build.arch}}" in
      x86*)
      	# DYNAMIC_ARCH is supported on x86* only, see
      	# https://github.com/xianyi/OpenBLAS/issues/709
      	_flags="$_flags DYNAMIC_ARCH=1"
      	;;
      *)
      	_flags="$_flags DYNAMIC_ARCH=0"
      	;;
      esac

      case "${{build.arch}}" in
      x86*)
      	_flags="$_flags TARGET=CORE2"
      	;;
      aarch64)
      	_flags="$_flags TARGET=ARMV8"
      	;;
      esac

      # Flags for ILP64 variant.
      _flags64="
      	$_flags
      	INTERFACE64=1
      	SYMBOLSUFFIX=64_
      	"
      export CFLAGS=${CFLAGS/-Os/-O2}

      make -C "$builddir" -j$(nproc) $_flags CFLAGS="$CFLAGS"
      make -C "$builddir" -j$(nproc) ./interface $_flags CFLAGS="$CFLAGS" shared-blas-lapack
      if $_ilp64; then
      	msg "Building with ILP64..."
      	make -C "$builddir" -j$(nproc) $_flags64 CFLAGS="$CFLAGS"
      fi

      if $_ilp64; then
      	make -C "$builddir" -j$(nproc) $_flags64 DESTDIR="${{targets.destdir}}" install
      fi
      mkdir -p "${{targets.destdir}}"/usr/lib
      mkdir -p "${{targets.destdir}}"/usr/share/doc/${{package.name}}
      make $_flags DESTDIR="${{targets.destdir}}" install
      install -Dm755 ./interface/liblapack.so.3 \
      	"${{targets.destdir}}"/usr/lib/liblapack.so.3
      ln -s liblapack.so.3 "${{targets.destdir}}"/usr/lib/liblapack.so
      install -Dm755 ./interface/liblapacke.so.3 \
      	"${{targets.destdir}}"/usr/lib/liblapacke.so.3
      ln -s liblapacke.so.3 "${{targets.destdir}}"/usr/lib/liblapacke.so
      install -Dm 0644 Changelog.txt TargetList.txt USAGE.md \
      	-t "${{targets.destdir}}"/usr/share/doc/${{package.name}}/

  - uses: strip

update:
  enabled: true
  github:
    identifier: xianyi/openblas
    strip-prefix: v
    use-tag: true
