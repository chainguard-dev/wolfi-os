package:
  name: dotty
  version: 3.6.2
  epoch: 0
  description: The Scala 3 compiler, also known as Dotty.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash
    provides:
      - scala=${{package.full-version}}

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - openjdk-11-default-jvm
      - openjdk-11-jre
      - sbt
      - unzip

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/lampepfl/dotty
      tag: ${{package.version}}
      expected-commit: ad3f69867b4600a3550bf9e76a1fc58091cb5eaf

  - name: Build Dotty
    runs: |
      sbt dist/Universal/packageBin

  - name: Install Dotty
    runs: |
      # Create the directories with the correct permissions
      mkdir -p ${{targets.destdir}}/usr/bin
      install -dm755 "${{targets.destdir}}"/usr/share/scala/bin
      install -dm755 "${{targets.destdir}}"/usr/share/scala/lib
      install -dm755 "${{targets.destdir}}"/usr/share/scala/libexec

      # Extract the zip file
      unzip dist/target/universal/scala3-${{package.version}}-bin-SNAPSHOT.zip -d target/universal

      # Cleaning and removing windows batch files
      rm -rf dist/target/universal/scala3-${{package.version}}-bin-SNAPSHOT/bin/*.bat
      rm -rf dist/target/universal/scala3-${{package.version}}-bin-SNAPSHOT/libexec/*.bat

      mv target/universal/scala3-${{package.version}}-bin-SNAPSHOT/bin/* ${{targets.destdir}}/usr/share/scala/bin/
      mv target/universal/scala3-${{package.version}}-bin-SNAPSHOT/lib/* ${{targets.destdir}}/usr/share/scala/lib/
      mv target/universal/scala3-${{package.version}}-bin-SNAPSHOT/libexec/* ${{targets.destdir}}/usr/share/scala/libexec/
      ln -sf /usr/share/scala/bin/scala ${{targets.destdir}}/usr/bin/scala
      ln -sf /usr/share/scala/bin/scalac ${{targets.destdir}}/usr/bin/scalac
      ln -sf /usr/share/scala/bin/scaladoc ${{targets.destdir}}/usr/bin/scaladoc

update:
  enabled: true
  github:
    identifier: lampepfl/dotty
