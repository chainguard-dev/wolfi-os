package:
  name: argocd-cli
  version: 2.6.2
  epoch: 0
  description: "Declarative continuous deployment for Kubernetes."
  copyright:
      license: Apache License 2.0
  dependencies:
    runtime:
      - ca-certificates-bundle
environment:
  contents:
    packages:
      - ca-certificates-bundle
      - busybox
      - go
pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/argoproj/argo-cd
      tag: v${{package.version}}
      expected-commit: 6e02f8b23201b0620a4ff1bce5d38229ba1eb02e
      destination: argo-cd
  #TODO(kamesh) - simplify this using go/build pipeline
  # but it requires few OOTB variables
  - name: build argocd cli
    runs: |
      set +x
      cd argo-cd
      mkdir -p "${{targets.destdir}}/usr/bin"
      build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
      git_commit=$(git rev-parse HEAD)
      git_tree_state=$(git status --porcelain)
      kubectl_version=$(go list -m k8s.io/client-go | head -n 1 | rev | cut -d' ' -f1 | rev)
      CGO_ENABLED=0 go build -v \
        -trimpath -ldflags \
        "-X github.com/argoproj/argo-cd/v2/common.version=${{package.version}} -X github.com/argoproj/argo-cd/v2/common.buildDate==${build_date} -X github.com/argoproj/argo-cd/v2/common.gitCommit=${git_commit} -X github.com/argoproj/argo-cd/v2/common.gitTreeState=${git_tree_state} -X github.com/argoproj/argo-cd/v2/common.kubectlVersion=${kubectl_version}" \
        -o "${{targets.destdir}}/usr/bin/argocd" ./cmd
  - name: ensure binary has right version info
    runs: |
       ${{targets.destdir}}/usr/bin/argocd --version --client | grep "argocd: v${{package.version}}"
  - uses: strip
