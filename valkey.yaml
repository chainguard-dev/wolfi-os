package:
  name: valkey
  version: 8.0.1
  epoch: 1
  description: Advanced key-value store
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - posix-libc-utils # `getent` is required on startup in ha mode for ip introspection cluster formation

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - linux-headers
      - openssf-compiler-options
      - openssl-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/valkey-io/valkey
      tag: ${{package.version}}
      expected-commit: 4fbab5740bfef66918d6c2950dd2b3b4e07815a2

  - uses: patch
    with:
      patches: 0000-Disable-protected-mode.patch

  - uses: redis-valkey/make

  - uses: strip

# subpackage descriptions are in the build pipeline
subpackages:
  - name: valkey-cli
    pipeline:
      - uses: redis-valkey/subpackage-cli
        with:
          project: valkey
    test:
      pipeline:
        - runs: |
            valkey-cli --version
            valkey-cli --help

  - name: valkey-benchmark
    pipeline:
      - uses: redis-valkey/subpackage-benchmark
        with:
          project: valkey
    test:
      pipeline:
        - runs: |
            valkey-benchmark --version
            valkey-benchmark --help

update:
  enabled: true
  github:
    identifier: valkey-io/valkey

test:
  environment:
    contents:
      packages:
        - valkey-cli
  pipeline:
    - uses: redis-valkey/tests
      with:
        project: valkey
