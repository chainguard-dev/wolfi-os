# Generated from https://git.alpinelinux.org/aports/plain/main/zfs/APKBUILD
package:
  name: zfs
  version: 2.2.0
  epoch: 0
  description: Advanced filesystem and volume manager
  copyright:
    - license: CDDL-1.0

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - build-base
      - automake
      - autoconf
      - attr-dev
      - e2fsprogs-dev
      - glib-dev
      - openssl-dev
      - util-linux-dev
      - linux-headers
      - libtool
      - libtirpc-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/openzfs/zfs
      expected-commit: 95785196f26e92d82cf4445654ba84e4a9671c57
      tag: zfs-${{package.version}}

  - runs: |
      export CFLAGS="$CFLAGS -fno-tree-vectorize"
      export CXXFLAGS="$CXXFLAGS -fno-tree-vectorize"
      ./autogen.sh
      ./configure \
        --prefix=/usr \
        --with-udevdir=/lib/udev \
        --disable-systemd \
        --disable-static \
        --with-python=3 \
        --with-tirpc \
        --sysconfdir=/etc \
        --mandir=/usr/share/man \
        --infodir=/usr/share/info \
        --localstatedir=/var \
        --with-config=user

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      rm -rf "${{targets.contextdir}}"/usr/share/initramfs-tools

  - uses: strip

subpackages:
  - name: zfs-dev
    pipeline:
      - uses: split/dev
    description: zfs dev

  - name: zfs-doc
    pipeline:
      - uses: split/manpages
    description: zfs manpages

  - name: zfs-udev
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/lib/udev
          mv ${{targets.contextdir}}/lib/udev/* ${{targets.contextdir}}/lib/udev/
    description: zfs udev

  - name: zfs-scripts
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/share/zfs
          mv ${{targets.contextdir}}/usr/share/zfs/* ${{targets.contextdir}}/usr/share/zfs/
    description: zfs scripts

  - name: zfs-utils-py
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/bin
          mv ${{targets.contextdir}}/usr/bin/arc_summary \
              ${{targets.contextdir}}/usr/bin/arcstat \
              ${{targets.contextdir}}/usr/bin/dbufstat \
              ${{targets.contextdir}}/usr/bin
    description: zfs utils

update:
  enabled: true
  github:
    identifier: openzfs/zfs
    strip-prefix: zfs-
    tag-filter: zfs-
