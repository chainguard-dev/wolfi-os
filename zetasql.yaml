package:
  name: zetasql
  version: 2024.08.2
  epoch: 0
  description: ZetaSQL - Analyzer Framework for SQL
  copyright:
    - license: Apache-2.0
  resources:
    cpu: 33
    memory: 100Gi

environment:
  contents:
    packages:
      - bash
      - bazel-6
      - binutils
      - build-base
      - busybox
      - ca-certificates-bundle
      - cmake
      - gcc-12-default
      - git
      - glibc-locale-en # This fixes the build failure with UTF-8 filenames, see wolfi-dev/os#26865
      - openjdk-17
      - openjdk-17-default-jvm
      - openssf-compiler-options
      - patch
      - python3
      - tzdata
      - wolfi-baselayout
  environment:
    BAZEL_ARGS: "--config=g++ --cxxopt=-std=c++17 --host_cxxopt=-std=c++17 --tool_java_runtime_version=local_jdk"
    JAVA_HOME: /usr/lib/jvm/java-17-openjdk
    LANG: en_US.UTF-8
    CC: gcc
    CXX: g++

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/google/zetasql
      tag: ${{package.version}}
      expected-commit: 194cd32b5d766d60e3ca442651d792c7fe54ea74

  - uses: patch
    with:
      patches: multi-arch-for-linux.patch

  - runs: |
      # odd permisson issue with bazel cache DONT MERGE UNTIL FIGURED OUT
      mkdir -p .cache/bazel/_bazel_root
      chmod -R 755 .cache/bazel/_bazel_root

      # DONT MERGE UNTIL FIGURED OUT
      attempt=1
      while [ $attempt -le 15 ]; do
        echo "Attempt $attempt of 10..."
        if bazel build --verbose_failures $BAZEL_ARGS -c opt zetasql/...; then
          echo "Build succeeded on attempt $attempt!"
          break
        fi
        echo "Build failed on attempt $attempt"
        attempt=$(( attempt + 1 ))
        [ $attempt -le 15 ] && sleep 2
      done
      [ $attempt -le 15 ] || exit 1

  - uses: strip

subpackages:
  - name: ${{package.name}}-dev
    description: ${{package.name}} dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - zetasql

update:
  enabled: true
  github:
    identifier: google/zetasql
    use-tag: true
