package:
  name: grpc
  version: 1.67.0
  epoch: 0
  description: The C based gRPC
  copyright:
    - license: Apache-2.0 AND BSD-3-Clause AND MIT
  resources:
    cpu: 24
    memory: 24Gi

# This melange produces two PHP subpackages: 'php-<VERSION>-grpc' and 'php-<VERSION>-grpc-config'
# We build these for the PHP versions listed here.
data:
  - name: php-versions
    items:
      3.10: '310'
      8.2: '82'
      8.3: '83'

environment:
  contents:
    packages:
      - abseil-cpp-dev
      - autoconf
      - automake
      - benchmark-dev
      - build-base
      - busybox
      - c-ares-dev
      - ca-certificates-bundle
      - chrpath
      - cmake
      - curl
      - cython~0
      - icu-dev
      - libstdc++-dev
      - libsystemd
      - libtool
      - linux-headers
      - openssl-dev
      - protobuf-dev
      - py3-setuptools
      - python3
      - python3-dev
      - re2
      - re2-dev
      - samurai
      - systemd-dev
      - wolfi-base
      - xxhash-dev
      - yaml-dev
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/grpc/grpc
      tag: v${{package.version}}
      expected-commit: 74f245857247b4b3e28a753d85d06ae2d5a55434

  - runs: |
      cd third_party
      git submodule update --init --recursive

  - runs: |
      mkdir -p "${{targets.destdir}}"/usr/share/doc/grpc
      cmake -B _build -G Ninja \
      	-DCMAKE_BUILD_TYPE=None \
      	-DCMAKE_INSTALL_PREFIX=/usr \
      	-DCMAKE_CXX_STANDARD=17 \
      	-DBUILD_SHARED_LIBS=True \
      	-DgRPC_INSTALL=ON \
      	-DgRPC_CARES_PROVIDER=package \
      	-DgRPC_SSL_PROVIDER=package \
      	-DgRPC_ZLIB_PROVIDER=package \
        -DgRPC_PROTOBUF_PROVIDER=package \
      	-DgRPC_ABSL_PROVIDER=package \
        -DgRPC_RE2_PROVIDER=package \
      	-DgRPC_BENCHMARK_PROVIDER=package \
      	-DgRPC_BACKWARDS_COMPATIBILITY_MODE=OFF \
      	-DgRPC_BUILD_TESTS=OFF
      cmake --build _build

      GRPC_PYTHON_CFLAGS="-std=c++17" \
      GRPC_PYTHON_DISABLE_LIBC_COMPATIBILITY=1 \
      GRPC_PYTHON_BUILD_SYSTEM_CARES=1 \
      GRPC_PYTHON_BUILD_SYSTEM_OPENSSL=1 \
      GRPC_PYTHON_BUILD_SYSTEM_ZLIB=1 \
      GRPC_PYTHON_BUILD_SYSTEM_RE2=1 \
      GRPC_PYTHON_BUILD_SYSTEM_ABSL=1 \
      python3 setup.py build

      # grpcio-tools
      cd tools/distrib/python
      python3 make_grpcio_tools.py

  - runs: |
      DESTDIR="${{targets.destdir}}" cmake --install _build
      python3 setup.py install --skip-build --root="${{targets.destdir}}"
      cd doc
      find ./ -type f -print -exec install -Dm644 {} "${{targets.destdir}}"/usr/share/doc/grpc/{} \;
      rm "${{targets.destdir}}"/usr/share/doc/grpc/.gitignore
      find "${{targets.destdir}}" -type f -name roots.pem -exec \
      sh -c 'rm $0 && ln -s /etc/ssl/certs/ca-certificates.crt $0' "{}" \;

subpackages:
  - name: py3-grpcio
    description: "gRPC Python HTTP/2-based RPC framework"
    dependencies:
      runtime:
        - py3-six
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr/lib
          mv ${{targets.destdir}}/usr/lib/python3* ${{targets.subpkgdir}}/usr/lib/

  - name: grpc-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - grpc
    description: grpc dev

  # According to the docs, we pass '--enable-grpc' here to point to the local
  # grpc binaries we produced, which are used as a buildtime dependency
  # -   # https://github.com/grpc/grpc/tree/master/src/php#build-from-source
  #
  # ****TODO*****
  # Need to be able to define buildtime dependencies at subpackage level. i.e
  # i.e php-<version> and php-<version>-dev
  # This would change for each subpackage we build targeted for PHP version.
  - range: php-versions
    name: "php-${{range.key}}-grpc"
    description: "A PHP extension for gRPC"
    dependencies:
      runtime:
        - php-${{range.key}}
        - php-${{range.key}}-grpc-config
    pipeline:
      - name: Configure
        runs: |
          cd src/php/ext/grpc
          phpize
          ./configure --enable-grpc="${{targets.destdir}}/usr/"
      - name: Make install
        runs: |
          cd src/php/ext/grpc
          INSTALL_ROOT="${{targets.subpkgdir}}" DESTDIR="${{targets.subpkgdir}}" make install

  - range: php-versions
    name: "php-${{range.key}}-grpc-config"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}/etc/php/conf.d"
          echo "extension=grpc.so" > "${{targets.subpkgdir}}/etc/php/conf.d/grpc.ini"

update:
  enabled: true
  github:
    identifier: grpc/grpc
    strip-prefix: v
    use-tag: true
