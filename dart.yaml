package:
  name: dart
  version: 3.6.0-294.0.dev
  epoch: 0
  description: The Dart SDK, including the VM, JS and Wasm compilers, analysis, core libraries, and more.
  copyright:
    - license: BSD-3-Clause

environment:
  contents:
    packages:
      - bash
      - busybox
      - curl
      - git
      - python3
      - xz

pipeline:
  - name: "clone the source code"
    runs: |
      mkdir -p ${{targets.destdir}}/usr/lib/
      mkdir -p ${{targets.destdir}}/runtime
      git clone --depth=1 https://chromium.googlesource.com/chromium/tools/depot_tools.git /home/depot_tools
      export PATH=$PATH:/home/depot_tools
      mkdir -p /home/dart-sdk
      cd /home/dart-sdk
      fetch dart

  - if: ${{build.arch}} == "x86_64"
    runs: |
      cd /home/dart-sdk/sdk
      git fetch --tags --all
      git checkout tags/${{package.version}} -b ${{package.version}}
      ./tools/build.py --mode release --arch x64 create_sdk
      mv out/ReleaseX64/dart-sdk ${{targets.destdir}}/usr/lib/dart
      cp /lib64/ld-linux-x86-64.so.2 ${{targets.destdir}}/runtime/

  - if: ${{build.arch}} == "aarch64"
    runs: |
      cd /home/dart-sdk/sdk
      git fetch --tags --all
      git checkout tags/${{package.version}} -b ${{package.version}}
      ./tools/build.py --mode release --arch arm create_sdk
      mv out/ReleaseIA32/dart-sdk ${{targets.destdir}}/usr/lib/dart
      cp /lib/ld-linux-aarch64.so.1 ${{targets.destdir}}/runtime/

  - name: "symlink dart binary and copy required libraries to runtime dir"
    runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      FILES="/lib/libc.so.6 /lib/libdl.so.2 /lib/libm.so.6 /lib/libnss_dns.so.2 /lib/libpthread.so.0 /lib/libresolv.so.2 /lib/librt.so.1"
      for file in $FILES; do
        cp -L $file ${{targets.destdir}}/runtime/
      done
      ln -sf /usr/lib/dart/bin/dart "${{targets.destdir}}"/usr/bin/dart

update:
  enabled: false
  manual: true
  github:
    identifier: dart-lang/sdk
    use-tag: true

test:
  pipeline:
    - name: "dart version"
      runs: /usr/bin/dart --version
    - name: "hello world dart program"
      runs: |
        cat > /tmp/hello.dart <<EOF
        void main() {
          print('Hello, World!');
        }
        EOF
        /usr/bin/dart /tmp/hello.dart
