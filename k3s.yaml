package:
  name: k3s
  version: 1.27.2_k3s1
  epoch: 0
  description: 
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - go
      - git
      - curl
      - yq
      - libseccomp-dev
      - zstd

var-transforms:
  - from: ${{package.version}}
    match: \_
    replace: +
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/k3s-io/k3s
      tag: v${{vars.mangled-package-version}}
      expected-commit: 213d7ad499e166290872f51c63d8eaa2f1fe78b3

  - runs: |
      # k3s normally uses a tool called dapper to do this in a consistent environment
      # melange already provides a consistent environment, so we can just do it manually
      # thankfully the dapper wrapper stuff is just a few levels of indirection
      # from calling these scripts in the right order, so what could go wrong?
      
      mkdir -p build/data bin build/static
      ./scripts/generate
      ./scripts/download
      ./scripts/build
      
      # The package script tries to package images as well, comment that part out:
      sed -i 's/^\.\/package-image/#&/' ./scripts/package
      SKIP_AIRGAP=1 ./scripts/package

      mkdir -p ${{targets.destdir}}/usr/bin
      mv dist/artifacts/k3s-* ${{targets.destdir}}/usr/bin/k3s

update:
  enabled: true
  github:
    identifier: k3s-io/k3s
    strip-prefix: v
