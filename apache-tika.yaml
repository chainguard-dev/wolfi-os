package:
  name: apache-tika
  version: 3.0.0
  epoch: 0
  description: The Apache Tika toolkit detects and extracts metadata and text from over a thousand different file types (such as PPT, XLS, and PDF).
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - coreutils
      - fontconfig-config
      - fontconfig-dev
      - lcms2
      - libfontconfig1
      - libjpeg-turbo
      - maven
      - openjdk-17-default-jdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apache/tika
      tag: ${{package.version}}
      expected-commit: 9bcb38d6734ed9d5dcff617f316c535e844c68d1

  - runs: |
      mvn clean install -am -DskipTests -Dossindex.skip
      mkdir -p "${{targets.contextdir}}"
      cp -r tika-server/tika-server-standard/target/tika-server-standard-${{package.version}}.jar "${{targets.contextdir}}"

update:
  enabled: true
  github:
    identifier: apache/tika
    use-tag: true

test:
  environment:
    contents:
      packages:
        - curl
        - openjdk-17-default-jdk
  pipeline:
    - name: "start server and verify root endpoint"
      runs: |
        sleep 5
        (
          java -jar /tika-server-standard-3.0.0.jar &
        ) && \
        sleep 2 && \
        curl -s http://localhost:9998/ | \
        grep "<h1>Welcome to the Apache Tika 3.0.0 Server</h1>"
    - name: "test /tika endpoint with sample text file"
      runs: |
        sleep 5
        echo "this is a test file!" > sample.txt
        (
          java -jar /tika-server-standard-3.0.0.jar &
        ) &&
        sleep 2 && \
        curl -X PUT --data-binary @sample.txt -H "Content-Type: text/plain" http://localhost:9998/tika | \
        grep "this is a test file!"
