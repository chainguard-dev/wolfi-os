package:
  name: bind
  version: 9.18.19
  epoch: 0
  description: The ISC DNS server
  copyright:
    - license: MPL-2.0

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - build-base
      - automake
      - autoconf
      - bash
      - fstrm-dev
      - krb5-dev
      - libcap-dev
      - libuv-dev
      - libxml2-dev
      - nghttp2-dev
      - openldap-dev
      - openssl-dev
      - perl
      - protobuf-c-dev
      - dnssec-root
      - dns-root-hints

pipeline:
  - uses: fetch
    with:
      expected-sha256: 115e09c05439bebade1d272eda08fa88eb3b60129edef690588c87a4d27612cc
      uri: https://downloads.isc.org/isc/bind9/${{package.version}}/bind-${{package.version}}.tar.xz

  - uses: autoconf/configure
    with:
      opts: |
        --host=${{host.triplet.gnu}} \
        --build=${{host.triplet.gnu}} \
        --with-gssapi=yes \
        --with-libxml2 \
        --with-openssl=yes \
        --enable-dnstap \
        --enable-largefile \
        --enable-linux-caps \
        --enable-shared \
        --disable-static

  - uses: autoconf/make

  - uses: autoconf/make-install

  - runs: |
      # removed -g named -o root
      install -d -m0770 ${{targets.contextdir}}/var/bind \
        ${{targets.contextdir}}/var/bind/sec \
        ${{targets.contextdir}}/var/bind/dyn

      # removed -g named -o root
      install -d -m0750 ${{targets.contextdir}}/etc/bind \
        ${{targets.contextdir}}/var/bind/pri

      make -j1 DESTDIR=${{targets.contextdir}} install


      install -Dm644 named.confd \
        ${{targets.contextdir}}/etc/conf.d/named
      install -Dm644 named.conf.authoritative \
        ${{targets.contextdir}}/etc/bind/named.conf.authoritative
      install -Dm644 named.conf.recursive \
        ${{targets.contextdir}}/etc/bind/named.conf.recursive
      install -Dm644 127.zone \
        ${{targets.contextdir}}/var/bind/pri/127.zone
      install -Dm644 localhost.zone \
        ${{targets.contextdir}}/var/bind/pri/localhost.zone

      cd ${{targets.contextdir}}/var/bind
      ln -s ../../usr/share/dns-root-hints/named.root named.ca
      ln -s named.ca root.cache

  - uses: strip

subpackages:
  - name: bind-doc
    pipeline:
      - uses: split/manpages
      - uses: split/infodir
    description: bind manpages

  - name: bind-dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - bind
        - bind-plugins
        - bind-tools
        - dns-root-hints
    description: bind dev

  - name: bind-libs
    dependencies:
      runtime:
        - keyutils-libs
        - krb5-conf
        - fstrm
        - protobuf-c
        - nghttp2-dev
        - libnghttp2-14
    pipeline:
      - runs: |
          for dir in lib usr/lib; do
            for file in ${{targets.contextdir}}/$dir/lib*.so; do
              [ -f "$file" ] || continue
              mkdir -p ${{targets.contextdir}}/$dir
              mv "$file" ${{targets.contextdir}}/$dir/
            done
          done
    description: bind (libraries)

  - name: bind-dnssec-root
    pipeline:
      - runs: |
          _dir="usr/share/dnssec-root"
          _file="bind-dnssec-root.keys"
          _link="${{targets.contextdir}}/etc/bind.keys"

          mkdir -p "${{targets.contextdir}}/$_dir"
          cd "${{targets.contextdir}}/$_dir"

          mv "$_link" "$_file"
          ln -s "$_file" bind.keys

          ln -s "../../$_dir/$_file" "$_link"
    description: ISC BIND DNSSEC Root Keys

  - name: bind-dnssec-tools
    dependencies:
      runtime:
        - bind-tools
        - libgcrypt
        - libxml2
        - curl
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/bin
          mv  \
            ${{targets.contextdir}}/usr/bin/nsec3hash \
            ${{targets.contextdir}}/usr/bin/dnssec* \
            ${{targets.contextdir}}/usr/bin/
    description: Utilities for DNSSEC keys and DNS zone files management

  - name: bind-plugins
    dependencies:
      runtime:
        - bind
        - bind-tools
        - bind-libs
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib
          mv ${{targets.contextdir}}/usr/lib/bind ${{targets.contextdir}}/usr/lib/
    description: The ISC DNS server plugins

  - name: bind-tools
    dependencies:
      runtime:
        - bind-libs
        - krb5-libs
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/bin
          for i in ${{targets.contextdir}}/usr/bin/*; do
            case "${i##*/}" in
              named-checkconf) ;;
              *) mv "$i" ${{targets.contextdir}}/usr/bin ;;
            esac
          done

          mkdir -p ${{targets.contextdir}}/usr/sbin
          for i in ${{targets.contextdir}}/usr/sbin/*; do
            case "${i##*/}" in
              named|rndc) ;;
              *) mv "$i" ${{targets.contextdir}}/usr/sbin ;;
            esac
          done
    description: The ISC DNS tools

update:
  enabled: true
  release-monitor:
    identifier: 242117
