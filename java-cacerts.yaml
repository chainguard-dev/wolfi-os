package:
  name: java-cacerts
  # Update this when ca-certificates is updated.
  version: "20240705"
  epoch: 0
  description: "default certificate authorities for Java"
  copyright:
    - license: MIT
  dependencies:
    runtime:
      - ca-certificates
      - p11-kit-trust

environment:
  contents:
    packages:
      - ca-certificates
      - p11-kit-trust
      - wolfi-base

pipeline:
  - runs: |
      EPOCH=$SOURCE_DATE_EPOCH
      unset SOURCE_DATE_EPOCH
      mkdir -p "${{targets.destdir}}"/etc/ssl/certs/java
      trust extract --overwrite --format=java-cacerts --filter=ca-anchors \
        --purpose server-auth "${{targets.destdir}}"/etc/ssl/certs/java/cacerts
      touch -d @$EPOCH "${{targets.destdir}}"/etc/ssl/certs/java/cacerts

  - runs: |
      mkdir -p "${{targets.destdir}}"/etc/ca-certificates/update.d
      cat > "${{targets.destdir}}"/etc/ca-certificates/update.d/java-cacerts <<EOF
      exec trust extract --overwrite --format=java-cacerts --filter=ca-anchors \
        --purpose server-auth /etc/ssl/certs/java/cacerts
      EOF
      chmod +x "${{targets.destdir}}"/etc/ca-certificates/update.d/java-cacerts

update:
  enabled: false

test:
  environment:
    contents:
      packages:
        - ca-certificates
  pipeline:
    - name: Verify java-cacerts installation
      runs: |
        if [ -f /etc/ssl/certs/java/cacerts ]; then
          echo "java-cacerts is installed."
          exit 0
        else
          echo "java-cacerts is not installed."
          exit 1
        fi
    - name: Check certificate file
      runs: |
        if [ -r /etc/ssl/certs/java/cacerts ]; then
          echo "Certificate file is present and readable."
          exit 0
        else
          echo "Certificate file is missing or not readable."
          exit 1
        fi
