package:
  name: pstack
  version: 2.4.5
  epoch: 0
  description: "Print stack traces from running processes, or core files."
  copyright:
    - license: BSD-2-Clause

environment:
  contents:
    packages:
      - wolfi-base
      - build-base
      - cmake
      - python-3.12
      - xz
      - zlib-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/peadar/pstack
      tag: v${{package.version}}
      expected-commit: 9490d48f908d0e0a7cee9066a281a64ebf7fe259

  - name: Set directories
    runs: |
      mkdir -p "${{targets.contextdir}}"/usr/bin
      mkdir -p "${{targets.contextdir}}"/usr/include/
      mkdir -p "${{targets.contextdir}}"/usr/lib/
      mkdir -p "${{targets.contextdir}}"/usr/share/
      mkdir -p "${{targets.contextdir}}"/usr/share/licenses/pstack/
      mkdir -p "${{targets.contextdir}}"/usr/share/man/man1/

  - name: Configure
    runs: |
      cmake -B build \
      -DCMAKE_INSTALL_PREFIX=/usr \
      -DVERSION_TAG="${{package.version}}" \
      -DPYTHON3=OFF \
      -DPYTHON2=OFF \
      -Wno-dev

  - name: Build
    runs: |
      cmake --build build

  - name: Install
    runs: |
      install -m755 build/pstack "${{targets.contextdir}}"/usr/bin/
      install -m755 build/canal "${{targets.contextdir}}"/usr/bin/
      install -m755 build/hdmp "${{targets.contextdir}}"/usr/bin/
      mv libpstack "${{targets.contextdir}}"/usr/include/
      mv build/*.so* "${{targets.contextdir}}"/usr/lib/
      mv LICENSE "${{targets.contextdir}}"/usr/share/licenses/
      mv pstack.1 "${{targets.contextdir}}"/usr/share/man/man1/

  - uses: strip

subpackages:
  - name: pstack-doc
    description: pstrack manpages
    pipeline:
      - runs: |
          cd "${{targets.contextdir}}"
          mkdir -p "${{targets.contextdir}}"/usr/share/man/man1/
          mv -f "${{targets.contextdir}}"/usr/share/man/man1/pstack.1 "${{targets.contextdir}}"/usr/share/man/man1/

update:
  enabled: true
  github:
    identifier: peadar/pstack
    strip-prefix: v
    use-tag: true
    tag-filter: v
