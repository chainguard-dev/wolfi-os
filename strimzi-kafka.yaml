package:
  name: strimzi-kafka
  version: 0.40.0
  epoch: 0
  description: Kafka addons for Strimzi
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash
      - cruise-control
      - kafka
      - openjdk-17-jre

environment:
  environment:
    JAVA_HOME: /usr/lib/jvm/java-17-openjdk
    JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF8
    KAFKA_HOME: /usr/lib/kafka
    HOME: /home/build
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - curl
      - make
      - maven
      - openjdk-17
      - zip

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/strimzi/strimzi-kafka-operator
      tag: ${{package.version}}
      expected-commit: 1b5ce127db873913923f267ed4e213c719179a59

  - runs: |
      set -e
      mkdir -p ${{targets.destdir}}/opt
      mkdir -p ${{targets.destdir}}/${KAFKA_HOME}/libs

      # Build the Kafka thirdparty libs
      cd ./docker-images/artifacts
      mvn dependency:copy-dependencies ${MVN_ARGS} -f ./kafka-thirdparty-libs/3.7.x/pom.xml
      mkdir -p ./binaries/kafka-thirdparty-libs
      rm -f ./binaries/kafka-thirdparty-libs/3.7.x.zip
      zip -j ./binaries/kafka-thirdparty-libs/3.7.x.zip kafka-thirdparty-libs/3.7.x/target/dependency/*
      cp kafka-thirdparty-libs/3.7.x/target/dependency/* ${{targets.destdir}}/${KAFKA_HOME}/libs/
      cd -

      # Build the strimzi agents
      for component in kafka-agent mirror-maker-agent tracing-agent; do
        cd ./${component}
        make java_install
        cp target/${component}-${{package.version}}.jar ${{targets.destdir}}/${KAFKA_HOME}/libs/
        cd -
      done

      # Copy the Kafka exporter scripts
      mkdir -p ${{targets.destdir}}/opt/kafka-exporter
      cp ./docker-images/kafka-based/kafka/exporter-scripts/kafka_exporter_run.sh ${{targets.destdir}}/opt/kafka-exporter/kafka_exporter_run.sh

      # Symlink KAFKA_HOME to /opt/kafka
      ln -sf "${KAFKA_HOME}" ${{targets.destdir}}/opt/kafka

      # Remove JARs that Kafka already provides
      rm ${{targets.destdir}}/usr/lib/kafka/libs/jackson-annotations-*.jar
      rm ${{targets.destdir}}/usr/lib/kafka/libs/jackson-core-*.jar
      rm ${{targets.destdir}}/usr/lib/kafka/libs/jackson-databind-*.jar
      rm ${{targets.destdir}}/usr/lib/kafka/libs/jsr305-*.jar
      rm ${{targets.destdir}}/usr/lib/kafka/libs/metrics-core-*.jar

update:
  enabled: true
  github:
    identifier: strimzi/strimzi-kafka-operator
    use-tag: true
