package:
  name: strimzi-kafka
  version: 0.40.0
  epoch: 0
  description: Kafka addons for Strimzi
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash
      - cruise-control
      - kafka
      - kafka_exporter
      - openjdk-17-jre

environment:
  environment:
    JAVA_HOME: /usr/lib/jvm/java-17-openjdk
    JAVA_TOOL_OPTIONS: -Dfile.encoding=UTF8
    KAFKA_HOME: /usr/lib/kafka
    HOME: /home/build
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - curl
      - kafka
      - make
      - maven
      - openjdk-17
      - zip

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/strimzi/strimzi-kafka-operator
      tag: ${{package.version}}
      expected-commit: 1b5ce127db873913923f267ed4e213c719179a59

  - runs: |
      set -e

      mkdir -p "${{targets.contextdir}}/opt"
      mkdir -p "${{targets.contextdir}}/${KAFKA_HOME}/libs"

      # Build the Kafka thirdparty libs
      cd ./docker-images/artifacts
      mvn dependency:copy-dependencies ${MVN_ARGS} -f ./kafka-thirdparty-libs/3.7.x/pom.xml
      mkdir -p ./binaries/kafka-thirdparty-libs
      rm -f ./binaries/kafka-thirdparty-libs/3.7.x.zip
      zip -j ./binaries/kafka-thirdparty-libs/3.7.x.zip kafka-thirdparty-libs/3.7.x/target/dependency/*
      cp kafka-thirdparty-libs/3.7.x/target/dependency/* "${{targets.contextdir}}/${KAFKA_HOME}/libs/"
      cd -

      # Build the strimzi agents
      for component in kafka-agent mirror-maker-agent tracing-agent; do
        cd "./${component}"
        make java_install
        cp "target/${component}-${{package.version}}.jar" "${{targets.contextdir}}/${KAFKA_HOME}/libs/"
        cd -
      done

      # Copy the Kafka scripts
      cp -r ./docker-images/kafka-based/kafka/scripts/* "${{targets.contextdir}}/${KAFKA_HOME}/"

      # Copy the Kafka exporter scripts
      mkdir -p ${{targets.contextdir}}/opt/kafka-exporter
      cp -r ./docker-images/kafka-based/kafka/exporter-scripts/* "${{targets.contextdir}}/opt/kafka-exporter/"

      # Copy the Cruise Control scripts
      mkdir -p "${{targets.contextdir}}/opt/cruise-control"
      cp -r ./docker-images/kafka-based/kafka/cruise-control-scripts/* "${{targets.contextdir}}/opt/cruise-control/"

      # Symlink KAFKA_HOME to /opt/kafka
      ln -sf "${KAFKA_HOME}" "${{targets.contextdir}}/opt/kafka"

      # Symlink Kafka exporter to /opt/kafka-exporter
      mkdir -p "${{targets.contextdir}}/opt/kafka-exporter"
      ln -sf /usr/bin/kafka_exporter "${{targets.contextdir}}/opt/kafka-exporter/kafka_exporter"

      # Remove JARs that Kafka already provides
      cd "${{targets.contextdir}}/${KAFKA_HOME}/libs"
      for jar in *.jar; do
        if [[ -f "${KAFKA_HOME}/lib/${jar}" ]]; then
          rm "${jar}"
        fi
      done

update:
  enabled: true
  github:
    identifier: strimzi/strimzi-kafka-operator
    use-tag: true
