package:
  name: openvpn
  version: 2.6.6
  epoch: 0
  description: Robust, and highly configurable VPN (Virtual Private Network)
  copyright:
    - license: GPL-2.0
  dependencies:
    runtime:
      - busybox
      - iproute2
      - libnl3
      - openssl
      - glibc
      - liblz4-1
      - lzo

environment:
  contents:
    packages:
      - ca-certificates-bundle
      - build-base
      - iproute2
      - libtool
      - autoconf
      - automake
      - py3-docutils
      - busybox
      - linux-headers
      - libcap-ng-dev
      - openssl-dev
      - lz4-dev
      - lzo-dev
      - libnl3-dev
      - linux-pam-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/OpenVPN/openvpn
      expected-commit: c9540130121bfc21902a54c8e4c9bc1108695068
      tag: v${{package.version}}

  - runs: autoreconf -vif

  - uses: autoconf/configure
    with:
      opts: |
        --prefix=/usr \
        --host=${{host.triplet.gnu}} \
        --sysconfdir=/etc/openvpn \
        --mandir=/usr/share/man \
        --enable-iproute2 \
        --enable-x509-alt-usernameco

  - runs: make

  - uses: autoconf/make-install

  - runs: |
      mkdir -p "${{targets.contextdir}}"/etc/init.d/
      mkdir -p "${{targets.contextdir}}"/etc/conf.d/
      mkdir -p "${{targets.contextdir}}"/etc/openvpn/
      install -Dm644 doc/openvpn.8 "${{targets.contextdir}}"/usr/share/man/man8/openvpn.8
      install -Dm755 vendor/openvpn.initd "${{targets.contextdir}}"/etc/init.d/
      install -Dm644 vendor/openvpn.confd "${{targets.contextdir}}"/etc/conf.d/
      install -Dm755 vendor/up.sh "${{targets.contextdir}}"/etc/openvpn/up.sh
      install -Dm755 vendor/down.sh "${{targets.contextdir}}"/etc/openvpn/down.sh

  - uses: strip

subpackages:
  - name: openvpn-doc
    description: openvpn manpages
    pipeline:
      - uses: split/manpages
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/share/doc/openvpn/samples
          install -D -m644 doc/openvpn.8 "${{targets.contextdir}}"/usr/share/man/man8/openvpn.8
          cp -a sample/sample-* "${{targets.contextdir}}"/usr/share/doc/openvpn/samples
          install -D -m644 COPYING* "${{targets.contextdir}}"/usr/share/licenses/openvpn/COPYING

  - name: openvpn-dev
    description: openvpn dev
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - openvpn
        - openssl-dev
        - iproute2-minimal

  - name: openvpn-openrc
    description: openvpn openrc init
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/etc/init.d/
          mkdir -p "${{targets.contextdir}}"/etc/conf.d/
          install -Dm755 vendor/openvpn.initd "${{targets.contextdir}}"/etc/init.d/
          install -Dm644 vendor/openvpn.confd "${{targets.contextdir}}"/etc/conf.d/
    dependencies:
      runtime:
        - openssl-dev

  - name: openvpn-auth-pam
    description: openvpn dev
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/usr/lib/openvpn/plugins
          mv "${{targets.contextdir}}"/usr/lib/openvpn/plugins/*-auth-pam* "${{targets.contextdir}}"/usr/lib/openvpn/plugins/
    dependencies:
      runtime:
        - glibc
        - linux-pam
        - iproute2

  - name: openvpn-supervisor
    description: openvpn supervisor
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}"/etc/supervisor.d/
          install -Dm644 vendor/openvpn.supervisord.conf "${{targets.contextdir}}"/etc/supervisor.d/openvpn.conf
    dependencies:
      runtime:
        - openvpn-doc
        - supervisor

update:
  enabled: true
  github:
    identifier: OpenVPN/openvpn
    tag-filter: v
    strip-prefix: v
    use-tag: true
