name: CI build action

on:
  workflow_dispatch:
  push:
    branches:
      - ci-test/**
      - gh-readonly-queue/main/**

jobs:
  build:
    name: Test building of packages
    runs-on:
      - kabbage-default
    container:
      image: ghcr.io/wolfi-dev/sdk:latest@sha256:26f510522abb4923875e8424c611e41cdf5fd017117f1a88e234ec2f8da6a25c
      options: |
        --cap-add NET_ADMIN --cap-add SYS_ADMIN --security-opt seccomp=unconfined --security-opt apparmor:unconfined

    steps:
      - uses: actions/checkout@v3

      - name: 'Trust the github workspace'
        run: |
          # This is to avoid fatal errors about "dubious ownership" because we are
          # running inside of a container action with the workspace mounted in.
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: 'Generate local signing key'
        run: |
          make MELANGE="melange" local-melange.rsa
