package:
  name: wolfi-baselayout
  version: 20221118
  epoch: 0
  description: "baselayout data for Wolfi"
  target-architecture:
    - all
  copyright:
    - paths:
        - "*"
      attestation: TODO
      license: MIT
  dependencies:
    runtime:
      - glibc-locale-posix
environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/bootstrap/stage3
    keyring:
      - https://packages.wolfi.dev/bootstrap/stage3/wolfi-signing.rsa.pub
    packages:
      - wolfi-baselayout
      - busybox
pipeline:
  - name: Generate /etc/shadow
    runs: |
      awk -F: '{
          pw = ":!:"
          if ($1 == "root") { pw = "::" }
          print($1 pw ":0:::::")
      }' vendor/etc/passwd > vendor/etc/shadow
  - name: Generate /etc/os-release
    runs: |
      cat >vendor/etc/os-release <<EOF
      ID=wolfi
      NAME="Wolfi"
      PRETTY_NAME="Wolfi"
      VERSION_ID="${{package.version}}"
      HOME_URL="https://wolfi.dev"
      EOF
  - name: Install
    runs: |
      for i in bin etc etc/profile.d etc/secfixes.d home lib root var usr/bin usr/sbin usr/local tmp var/spool/cron; do
        mkdir -p "${{targets.destdir}}"/${i}
      done

      for i in lib64 usr/lib64 usr/local/lib64; do
        ln -s lib "${{targets.destdir}}"/${i}
      done

      for i in etc/passwd etc/group etc/shadow etc/services etc/hosts etc/profile etc/shells etc/protocols etc/inittab etc/profile.d/locale.sh etc/nsswitch.conf etc/os-release etc/secfixes.d/wolfi; do
        install -m644 vendor/${i} "${{targets.destdir}}"/${i}
      done

      install -m600 vendor/etc/shadow "${{targets.destdir}}"/etc/shadow

      ln -s /etc/crontabs "${{targets.destdir}}"/var/spool/cron/crontabs
      ln -s /proc/mounts "${{targets.destdir}}"/etc/mtab
      ln -s /var/mail "${{targets.destdir}}"/var/spool/mail
