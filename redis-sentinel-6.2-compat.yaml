#nolint:valid-pipeline-git-checkout-commit,valid-pipeline-git-checkout-tag
package:
  name: redis-sentinel-6.2-compat
  version: 6.2.13
  epoch: 0
  description: "Redis Sentinel provides high availability for Redis."
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - redis-cli-6.2
      - redis-sentinel-6.2
      - bash
      - busybox
      - coreutils
      - posix-libc-utils

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - bash
      - curl
      - openssl
      - procps

pipeline:
  - uses: git-checkout
    with:
      branch: main
      repository: https://github.com/bitnami/containers

  # am_i_root && ensure_user_exists functions are not needed for our case.
  - uses: patch
    with:
      patches: remove-user-check.patch

  - runs: |
      mkdir -p "${{targets.contextdir}}"/opt/bitnami
      mkdir -p "${{targets.contextdir}}"/opt/bitnami/licenses
      mkdir -p "${{targets.contextdir}}"/opt/bitnami/scripts
      mkdir -p "${{targets.contextdir}}"/opt/bitnami/etc
      mkdir -p "${{targets.contextdir}}"/opt/bitnami/redis-sentinel/bin
      mkdir -p "${{targets.contextdir}}"/opt/bitnami/redis-sentinel/logs
      mkdir -p "${{targets.contextdir}}"/opt/bitnami/redis-sentinel/tmp
      mkdir -p "${{targets.contextdir}}"/bitnami/redis-sentinel/conf

      cd bitnami/redis-sentinel/6.2/debian-11

      cp -R ./prebuildfs/opt/bitnami/* ${{targets.contextdir}}/opt/bitnami/
      cp -R ./rootfs/opt/bitnami/scripts ${{targets.contextdir}}/opt/bitnami/
      chmod g+rwX "${{targets.contextdir}}"/opt/bitnami

  - runs: |
      mkdir -p "${{targets.contextdir}}"/opt/bitnami/redis-sentinel/etc
      cp /home/build/sentinel.conf "${{targets.contextdir}}"/opt/bitnami/redis-sentinel/etc/sentinel.conf

  - runs: |
      ln -sf /usr/bin/redis-cli "${{targets.contextdir}}"/opt/bitnami/redis-sentinel/bin/redis-cli

  - uses: strip

update:
  enabled: false
  manual: true # This requires manual updates because of the upstream repo does not release tags and branches.
  github:
    identifier: bitnami/containers
