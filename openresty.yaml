package:
  name: openresty
  version: 1.25.3.1
  epoch: 0
  description: High Performance Web Platform Based on Nginx and LuaJIT
  dependencies:
    runtime:
      - gd
      - geoip
      - libgcc
      - libxslt
      - perl
      - zlib
      - luajit

environment:
  contents:
    packages:
      - autoconf
      - automake
      - build-base
      - busybox
      - coreutils
      - curl
      - gd-dev
      - geoip-dev
      - libxml2-dev
      - libxslt-dev
      - linux-headers
      - luajit-dev
      - make
      - openssl-dev
      - pcre-dev
      - perl-dev
      - readline-dev
      - zlib-dev

pipeline:
  - uses: fetch
    with:
      uri: https://openresty.org/download/openresty-${{package.version}}.tar.gz
      expected-sha256: 32ec1a253a5a13250355a075fe65b7d63ec45c560bbe213350f0992a57cd79df

  - runs: |
      ./configure \
        --build=${{host.triplet.gnu}} \
        --prefix=/usr \
        --with-pcre \
        --with-cc-opt='-DNGX_LUA_ABORT_AT_PANIC -I/usr/include' \
        --with-ld-opt='-L/usr/lib -Wl,-rpath,/usr/lib' \
        --with-compat \
        --with-file-aio \
        --with-http_addition_module \
        --with-http_auth_request_module \
        --with-http_dav_module \
        --with-http_flv_module \
        --with-http_geoip_module=dynamic \
        --with-http_gunzip_module \
        --with-http_gzip_static_module \
        --with-http_image_filter_module=dynamic \
        --with-http_mp4_module \
        --with-http_random_index_module \
        --with-http_realip_module \
        --with-http_secure_link_module \
        --with-http_slice_module \
        --with-http_ssl_module \
        --with-http_stub_status_module \
        --with-http_sub_module \
        --with-http_v2_module \
        --with-http_v3_module \
        --with-http_xslt_module=dynamic \
        --with-ipv6 \
        --with-mail \
        --with-mail_ssl_module \
        --with-md5-asm \
        --with-sha1-asm \
        --with-stream \
        --with-stream_ssl_module \
        --with-threads \
        --with-luajit=/usr \
        --with-luajit-xcflags='-DLUAJIT_NUMMODE=2 -DLUAJIT_ENABLE_LUA52COMPAT' \
        --with-pcre-jit

  - uses: autoconf/make

  - uses: autoconf/make-install

  - name: Create symlinks and directories
    runs: |
      mkdir -p /var/run/openresty
      ln -sf /dev/stdout ${{targets.destdir}}/usr/nginx/logs/access.log
      ln -sf /dev/stderr ${{targets.destdir}}/usr/nginx/logs/error.log
  
  - name: Setup default config files
    runs: |
      mkdir -p ${{targets.destdir}}/etc/nginx/conf.d
      tag=$(curl -s https://api.github.com/repos/openresty/docker-openresty/tags | \
        awk -F '"' '/"name": "'"$BASE_VERSION"'-[0-9]+"/ { print $4 }' | \
        sort -V | \
        tail -n 1)
      curl -o nginx.conf "https://raw.githubusercontent.com/openresty/docker-openresty/$tag/nginx.conf"
      curl -o default.conf "https://raw.githubusercontent.com/openresty/docker-openresty/$tag/nginx.vh.default.conf"
      cp nginx.conf ${{targets.destdir}}/usr/nginx/nginx.conf
      cp default.conf ${{targets.destdir}}/etc/nginx/conf.d/default.conf
      


  - uses: strip

test:
  pipeline:
    - runs: |
        resty -h
        resty -e 'print("hello")'

update:
  enabled: true
  release-monitor:
    identifier: 231952
