package:
  name: awx
  version: 24.6.1
  epoch: 0
  description: AWX provides a web-based user interface, REST API, and task engine built on top of Ansible
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - python-3.11

# To do- add py-twilio and py-zstd and hiredis-py
environment:
  contents:
    packages:
      - build-base
      - busybox
      - bash
      - make
      - ca-certificates-bundle
      - nodejs
      - npm
      - nvm
      - py3-sqlparse
      - py3.11-pip
      - python-3.11-dev
      - zlib-dev
      - py3-aiohttp
      - py3-cffi
      - py3-charset-normalizer
      - py3-pydantic-core
      - py3-cryptography
      - py3-cython
      - py3-frozenlist
      - py3-grpcio
      - py3-lxml
      - py3-markupsafe
      - py3-maturin
      - py3-msgpack
      - py3-multidict
      - py3-protobuf
      - py3-psutil
      - py3-psycopg
      - py3-pycparser
      - py3-rpds-py
      - py3-wrapt
      - py3-yarl
      - py3-pyyaml
      - py3-zope.interface
      - wolfi-base

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/ansible/awx.git
      tag: ${{package.version}}
      expected-commit: 94e5795dfc37b95c576d61f3e3b4e936c021548c

  - runs: |
      # Back-end build

      mkdir -p ${{targets.contextdir}}/var/lib/awx
      python -m venv --system-site-packages  ${{targets.contextdir}}/var/lib/awx/venv
      export VENV_BASE=${{targets.contextdir}} make requirements_awx

      # Remove unnecessary cache files
      rm -rf ${{targets.destdir}}/var/lib/awx/venv/bin/__pycache*

      # Replace build paths in scripts to use `/var/lib/awx/`
      sed -i "s|/home/build|/var/lib/awx/|g" ${{targets.destdir}}/var/lib/awx/venv/bin/*

      # Ensure system site packages are included by updating `pyvenv.cfg`
      sed -i "s|include-system-site-packages = false|include-system-site-packages = true|g" ${{targets.destdir}}/var/lib/awx/venv/pyvenv.cfg

  - runs: |
      # Front-end build
      npm --prefix awx/ui run build

  - runs: |
      mkdir -p ${{targets.destdir}}/app/awx-frontend
      cp -r ./awx/ui/build ${{targets.destdir}}/app/awx-frontend/
      cp manage.py MANIFEST.in README.md ${{targets.destdir}}/app/
      cp awx/ui/package.json ${{targets.destdir}}/app/awx-frontend/

update:
  enabled: true
  github:
    identifier: ansible/awx
    use-tag: true
