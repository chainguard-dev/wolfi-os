package:
  name: awx
  version: 24.6.1
  epoch: 0
  description: AWX provides a web-based user interface, REST API, and task engine built on top of Ansible
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - python-3.11

# To do- add py-twilio and py-zstd and hiredis-py
environment:
  contents:
    packages:
      - build-base
      - busybox
      - bash
      - make
      - ca-certificates-bundle
      - nodejs
      - npm
      - nvm
      - py3.11-pip
      - python-3.11-dev
      - zlib-dev
      - py3.11-aiohttp
      - py3.11-cffi
      - py3.11-charset-normalizer
      - py3.11-pydantic-core
      - py3.11-cryptography
      - py3.11-cython
      - py3.11-frozenlist
      - py3.11-grpcio
      - py3.11-lxml
      - py3.11-markupsafe
      - py3.11-maturin
      - py3.11-msgpack
      - py3.11-multidict
      - py3.11-protobuf
      - py3.11-psutil
      # - py3.11-psycopg
      - py3.11-pycparser
      - py3.11-rpds-py
      - py3.11-wrapt
      - py3.11-yarl
      - py3.11-pyyaml
      - py3.11-zope.interface      
      - py3.11-xmlsec
      - wolfi-base
      - libxml2
      - libxml2-dev
      - pkgconf
      - pkgconf-dev
      - xmlsec
      - xmlsec-dev
      - xmlsec-openssl
      - libffi-dev
      - openldap-dev

pipeline:
  - uses: git-checkout
    with:

      repository: https://github.com/ansible/awx.git
      tag: ${{package.version}}
      expected-commit: 94e5795dfc37b95c576d61f3e3b4e936c021548c

  - uses: patch
    with:
      patches: conflict-pip.patch

  - runs: |
        mkdir -p ${{targets.contextdir}}/var/lib/awx
        python -m venv --system-site-packages  ${{targets.contextdir}}/var/lib/awx/venv
        source ${{targets.contextdir}}/var/lib/awx/venv/bin/activate

        ${{targets.contextdir}}/var/lib/awx/venv/bin/pip install --upgrade pip==21.2.4 setuptools==69.0.2 setuptools_scm[toml]==8.0.4 wheel==0.42.0 cython==0.29.37
        export SRC_ONLY_PKGS="cffi,pycparser,psycopg,twilio"
        export VENV_BASE=${{targets.contextdir}}/var/lib/awx
        which xmlsec1
        make requirements_awx

        # Remove unnecessary cache files
        rm -rf ${{targets.destdir}}/var/lib/awx/venv/bin/__pycache*

        # Replace build paths in scripts to use `/var/lib/awx/`
        sed -i "s|/home/build|/var/lib/awx/|g" ${{targets.destdir}}/var/lib/awx/venv/bin/*

        # Ensure system site packages are included by updating `pyvenv.cfg`
        sed -i "s|include-system-site-packages = false|include-system-site-packages = true|g" ${{targets.destdir}}/var/lib/awx/venv/pyvenv.cfg

  # - runs: |
  #     # Front-end build
  #     npm install react-scripts
  #     npm --prefix awx/ui run build

  # - runs: |
  #     mkdir -p ${{targets.destdir}}/app/awx-frontend
  #     cp -r ./awx/ui/build ${{targets.destdir}}/app/awx-frontend/
  #     cp manage.py MANIFEST.in README.md ${{targets.destdir}}/app/
  #     cp awx/ui/package.json ${{targets.destdir}}/app/awx-frontend/

update:
  enabled: true
  github:
    identifier: ansible/awx
    use-tag: true
