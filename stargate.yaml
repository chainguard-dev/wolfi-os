package:
  name: stargate
  version: 2.0.23
  epoch: 0
  description: An open source data gateway
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - iproute2
      - jemalloc
      - libaio
      - openjdk-8-default-jvm

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - curl
      - maven
      - openjdk-8-default-jvm
  environment:
    LANG: en_US.UTF-8
    JAVA_HOME: /usr/lib/jvm/java-1.8-openjdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/stargate/stargate
      expected-commit: cb29935c8a21fe4aa3b91cc95fba15633b6b6625
      tag: v${{package.version}}

  - uses: patch
    with:
      patches: upgrade-deps.patch

  - runs: |
      mkdir -p "${{targets.destdir}}"/stargate
      mkdir -p "${{targets.destdir}}"/stargate/stargate-lib
      cd coordinator
      ./mvnw -B -ntp versions:set -DremoveSnapshot versions:commit
      ./mvnw -B -ntp -q -ff -D dse clean package -DskipTests
      curl -o "${{targets.destdir}}"/stargate/stargate-lib/persistence-dse-6.8-${{package.version}}.jar https://repo1.maven.org/maven2/io/stargate/db/dse/persistence-dse-6.8/${{package.version}}/persistence-dse-6.8-${{package.version}}.jar
      cp -r ./stargate-lib/* "${{targets.destdir}}"/stargate/stargate-lib/
      cp ./starctl "${{targets.destdir}}"/stargate/starctl

subpackages:
  - name: coordinator-4_0
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/stargate
          mkdir -p "${{targets.subpkgdir}}"/stargate/stargate-lib
          cp "${{targets.destdir}}"/stargate/starctl "${{targets.subpkgdir}}"/stargate/starctl
          cp "${{targets.destdir}}"/stargate/stargate-lib/persistence-cassandra-4.0*.jar "${{targets.subpkgdir}}"/stargate/stargate-lib/
          cp "${{targets.destdir}}"/stargate/stargate-lib/persistence-api*.jar "${{targets.subpkgdir}}"/stargate/stargate-lib/
          find "${{targets.subpkgdir}}"/stargate/stargate-lib/ -name "persistence-cassandra-*.jar" -not -name "persistence-cassandra-4.0*.jar" -exec rm -f {} \;
          rm -rf "${{targets.subpkgdir}}"/stargate/stargate-lib/persistence-dse-*.jar

  - name: coordinator-3_11
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/stargate
          mkdir -p "${{targets.subpkgdir}}"/stargate/stargate-lib
          cp "${{targets.destdir}}"/stargate/starctl "${{targets.subpkgdir}}"/stargate/starctl
          cp "${{targets.destdir}}"/stargate/stargate-lib/persistence-cassandra-3.11*.jar "${{targets.subpkgdir}}"/stargate/stargate-lib/
          cp "${{targets.destdir}}"/stargate/stargate-lib/persistence-api*.jar "${{targets.subpkgdir}}"/stargate/stargate-lib/
          find "${{targets.subpkgdir}}"/stargate/stargate-lib/ -name "persistence-cassandra-*.jar" -not -name "persistence-cassandra-3.11*.jar" -exec rm -f {} \;
          rm -rf "${{targets.subpkgdir}}"/stargate/stargate-lib/persistence-dse-*.jar

  - name: coordinator-dse-68
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/stargate
          mkdir -p "${{targets.subpkgdir}}"/stargate/stargate-lib
          cp "${{targets.destdir}}"/stargate/starctl "${{targets.subpkgdir}}"/stargate/starctl
          cp "${{targets.destdir}}"/stargate/stargate-lib/persistence-dse*.jar "${{targets.subpkgdir}}"/stargate/stargate-lib/
          cp "${{targets.destdir}}"/stargate/stargate-lib/persistence-api*.jar "${{targets.subpkgdir}}"/stargate/stargate-lib/
          rm -rf "${{targets.subpkgdir}}"/stargate/stargate-lib/persistence-cassandra-*.jar

update:
  enabled: true
  github:
    identifier: stargate/stargate
    strip-prefix: v
