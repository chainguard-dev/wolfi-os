package:
  name: flyway
  version: 11.1.0
  epoch: 0
  description: "Flyway is a database migration tool to evolve your database schema easily and reliably across all your instances."
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - bash
      - openjdk-17-default-jvm

environment:
  contents:
    packages:
      - build-base
      - busybox
      - git
      - maven
      - openjdk-17
      - wolfi-base
  environment:
    LANG: en_US.UTF-8
    JAVA_HOME: /usr/lib/jvm/java-17-openjdk


pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/flyway/flyway
      tag: flyway-${{package.version}}
      expected-commit: c9218c6b67cc3fd53d16ea58094903e915dfc100

  - name: Install
    runs: |
      
      # Setup flyway dirs
      mkdir -p ${{targets.destdir}}/usr/share/java/flyway
      for dir in lib lib/flyway conf licenses drivers drivers/cassandra drivers/gcp; do
        mkdir -p ${{targets.destdir}}/usr/share/java/flyway/$dir
      done

      # Build flyway
      ./mvnw -B clean dependency:copy-dependencies package -e --file pom.xml -DskipTests -pl !flyway-database/flyway-database-mongodb      

      # Move over flyway related cmd scripts, license info, etc.
      cp flyway-commandline/src/main/assembly/oss/flyway ${{targets.contextdir}}/usr/share/java/flyway/
      cp flyway-commandline/src/main/assembly/oss/flyway.cmd ${{targets.contextdir}}/usr/share/java/flyway/
      cp flyway-commandline/src/main/assembly/LICENSE.md ${{targets.contextdir}}/usr/share/java/flyway/licenses
      cp flyway-commandline/src/main/assembly/LICENSES-THIRD-PARTY.txt ${{targets.contextdir}}/usr/share/java/flyway/licenses
      cp flyway-commandline/src/main/assembly/flyway.toml.example ${{targets.contextdir}}/usr/share/java/flyway/conf
      
      # Move over flyway related jars
      cp flyway-commandline/target/flyway-commandline-${{package.version}}.jar ${{targets.contextdir}}/usr/share/java/flyway/lib/flyway
      cp flyway-core/target/flyway-core-${{package.version}}.jar ${{targets.contextdir}}/usr/share/java/flyway/lib/flyway
      cp flyway-database/flyway-*/target/flyway-*-${{package.version}}.jar ${{targets.contextdir}}/usr/share/java/flyway/lib/flyway
      cp flyway-experimental/flyway-experimental-scanners/target/flyway-experimental-scanners-${{package.version}}.jar ${{targets.contextdir}}/usr/share/java/flyway/lib/flyway
      cp flyway-experimental/flyway-verb-*/target/flyway-verb-*-${{package.version}}.jar ${{targets.contextdir}}/usr/share/java/flyway/lib/flyway
      cp flyway-reports/target/flyway-reports-${{package.version}}.jar ${{targets.contextdir}}/usr/share/java/flyway/lib/flyway

      # Move over third party dependency jars
      cp flyway-commandline/target/dependency/*.jar ${{targets.contextdir}}/usr/share/java/flyway/lib

      # Setup permissions for flyway cli tools
      chmod 0755 ${{targets.destdir}}/usr/share/java/flyway/flyway ${{targets.destdir}}/usr/share/java/flyway/flyway.cmd
  
  - uses: strip

update:
  enabled: true
  github:
    identifier: flyway/flyway
    strip-prefix: flyway-