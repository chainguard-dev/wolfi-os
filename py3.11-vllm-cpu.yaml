package:
  name: py3.11-vllm-cpu
  version: 0.5.4
  epoch: 0
  description: A high-throughput and memory-efficient inference and serving engine for LLMs
  target-architecture:
    - x86_64
  options:
    no-depends: true
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - python-3.11

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - gcc-12-default
      - gperftools-dev
      - ninja-build
      - numactl-dev
      - py3.11-pip
      - python-3.11-dev
      - samurai
      - tcmalloc-minimal

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/vllm-project/vllm.git
      tag: v${{package.version}}
      expected-commit: 4db5176d9758b720b05460c50ace3c01026eb158

  - runs: |
      python3.11 -m venv .venv
      source .venv/bin/activate

      pip install --upgrade pip
      pip install build wheel packaging ninja "setuptools>=49.4.0" numpy
      pip install -v -r requirements-cpu.txt --extra-index-url https://download.pytorch.org/whl/cpu

      # Fixes CVE-2024-37891, CVE-2024-6345, CVE-2022-40897
      pip install urllib3==1.26.19 setuptools==70.0.0

      VLLM_TARGET_DEVICE=cpu python setup.py bdist_wheel
      pip install dist/vllm-*.whl

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/share/vllm
      mv .venv ${{targets.destdir}}/usr/share/vllm/

      rm -rf ${{targets.destdir}}/usr/share/vllm/.venv/bin/__pycache*
      sed -i "s|/home/build|/usr/share/vllm|g" ${{targets.destdir}}/usr/share/vllm/.venv/bin/*
      sed -i "s|include-system-site-packages = false|include-system-site-packages = true|g" ${{targets.destdir}}/usr/share/vllm/.venv/pyvenv.cfg

  - uses: strip

subpackages:
  - name: py3.11-wheels-vllm-cpu
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/share/wheels
          cp dist/*.whl ${{targets.contextdir}}/usr/share/wheels

update:
  enabled: true
  ignore-regex-patterns:
    - post
    - test
    - submission
  github:
    identifier: vllm-project/vllm
    strip-prefix: v
    use-tag: true

test:
  pipeline:
    - name: Verify vllm installation
      runs: |
        export PATH=/usr/share/vllm/.venv/bin:$PATH
        python -c "import vllm"
