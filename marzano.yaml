package:
  name: marzano
  version: 0.1.0_alpha.1727989739
  epoch: 0
  description: "a structural diff that understands syntax"
  copyright:
    - license: MIT

# Replace the last `.` with `-` to fetch the correct tag.
var-transforms:
  - from: ${{package.version}}
    match: '_'
    replace: "-"
    to: mangled-package-version

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - cargo-auditable
      - git
      - openssl-dev
      - perl
      - rust

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/getgrit/gritql
      tag: v${{vars.mangled-package-version}}
      expected-commit: 1146594a2c0d0286bf3b105c2414e046251e6e01
      recurse-submodules: true

  # Fixes incorrect?? feature references in various Cargo.toml files. 
  # The "dep:" syntax used for optional dependencies in feature definitions does not create 
  # implicit features. By removing "dep:" from these entries, we correctly reference the optional 
  # dependencies and enable the necessary features for building the project.
  - uses: patch
    with:
      patches: fix-core-dependency.patch fix-cli-dependency.patch fix-lsp-dependency.patch

  - runs: |
      cargo auditable build --release --features "tracing-opentelemetry"
      install -Dm755 target/release/marzano "${{targets.destdir}}"/usr/bin/marzano

  - uses: strip

update:
  enabled: true
  github:
    identifier: getgrit/gritql
    strip-prefix: v
    use-tag: true
  # Takes '0.1.0-alpha.1727989739' and converts into '0.1.0_alpha.1727989739'.
  version-transform:
    - match: ^(\d+\.\d+\.\d+)\-(.+)$
      replace: $1_$2

test:
  pipeline:
    - runs: |
        marzano --help
        marzano version
        marzano --version
    - runs: |
        marzano init
        marzano list | grep "SQL patterns"
