package:
  name: linkerd2
  version: 24.10.3
  epoch: 0
  description: "meta linkerd package"
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - cargo-auditable
      - clang
      - cmake
      - openssf-compiler-options
      - openssl-dev
      - perl-dev
      - rust

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 64130e1eb5313a4b15c5b279edeb6f263b70fdd5
      repository: https://github.com/linkerd/linkerd2/
      tag: edge-${{package.version}}

subpackages:
  - name: ${{package.name}}-cli
    pipeline:
      - runs: |
          go generate -mod=readonly ./pkg/charts/static
          go generate -mod=readonly ./jaeger/static
          go generate -mod=readonly ./multicluster/static
          go generate -mod=readonly ./viz/static
      - uses: go/build
        with:
          packages: ./cli
          tags: prod
          output: linkerd
          ldflags: -X github.com/linkerd/linkerd2/pkg/version.Version=edge-${{package.version}}
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}-cli
      pipeline:
        - name: linkerd version check
          runs: linkerd version --client

  - name: ${{package.name}}-proxy-identity
    pipeline:
      - uses: go/build
        with:
          packages: ./proxy-identity/main.go
          output: linkerd2-proxy-identity
      - runs: |
          mkdir -p ${{targets.contextdir}}/usr/lib/linkerd
          mv ${{targets.contextdir}}/usr/bin/linkerd2-proxy-identity ${{targets.contextdir}}/usr/lib/linkerd
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}-proxy-identity
      pipeline:
        - name: check presence of required files
          runs: |
            # executable doesn't have help or version flag.
            stat /usr/lib/linkerd/linkerd2-proxy-identity

  - name: ${{package.name}}-controller
    pipeline:
      - runs: |
          go generate -mod=readonly ./pkg/charts/static
      - uses: go/build
        with:
          packages: ./controller/cmd/main.go
          tags: prod
          output: controller
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}-controller
      pipeline:
        - name: check presence of required files
          runs: |
            # executable doesn't have help or version flag.
            stat /usr/bin/controller

  - name: ${{package.name}}-controller-compat
    description: "upstream image have executable placed at /"
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/
          ln -sf /usr/bin/controller ${{targets.contextdir}}/controller

  - name: ${{package.name}}-policy-controller
    pipeline:
      - runs: |
          export RUSTFLAGS="$RUSTFLAGS --cfg tokio_unstable"
          cargo fetch
          cargo auditable build --frozen --release --package=linkerd-policy-controller
          mkdir -p ${{targets.contextdir}}/usr/bin
          mv ./target/release/linkerd-policy-controller ${{targets.contextdir}}/usr/bin
      - uses: strip
    test:
      environment:
        contents:
          packages:
            - ${{package.name}}-policy-controller
      pipeline:
        - name: check presence of required files
          runs: |
            # executable doesn't have help or version flag.
            stat /usr/bin/linkerd-policy-controller

  - name: ${{package.name}}-policy-controller-compat
    description: "upstream image have executable placed at /bin"
    pipeline:
      - runs: |
          mkdir -p ${{targets.contextdir}}/bin/
          ln -sf /usr/bin/linkerd-policy-controller ${{targets.contextdir}}/bin/linkerd-policy-controller

update:
  enabled: true
  github:
    identifier: linkerd/linkerd2
    tag-filter: edge-
    strip-prefix: edge-
