package:
  name: sqlite
  version: 3.47.2
  epoch: 0
  description: "C library which implements an SQL database engine"
  copyright:
    - license: blessing

environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - openssf-compiler-options
      - readline

# ref: https://www.sqlite.org/download.html
# For version 3.X.Y the filename encoding is 3XX0Y00.
# 3.40.1 => 3400100 => https://www.sqlite.org/2022/sqlite-autoconf-3400100.tar.gz
var-transforms:
  - from: ${{package.version}}
    # transform 3.47.0 to 3470000 and 3.47.2 to 3470200 and similarly
    match: ^(\d+)\.(\d+)\.(\d+)$
    # replace here is appending 0 minor version and then appending two more zeros after patch version.
    replace: ${1}${2}0${3}00
    to: sqlite-download-version

pipeline:
  - uses: fetch
    with:
      uri: https://www.sqlite.org/2024/sqlite-autoconf-${{vars.sqlite-download-version}}.tar.gz
      expected-sha256: f1b2ee412c28d7472bc95ba996368d6f0cdcf00362affdadb27ed286c179540b

  - name: Configure
    runs: |
      _amalgamation="-DSQLITE_ENABLE_FTS4 \
        -DSQLITE_ENABLE_FTS3_PARENTHESIS \
        -DSQLITE_ENABLE_FTS3 \
        -DSQLITE_ENABLE_FTS5 \
        -DSQLITE_ENABLE_COLUMN_METADATA \
        -DSQLITE_SECURE_DELETE \
        -DSQLITE_ENABLE_UNLOCK_NOTIFY \
        -DSQLITE_ENABLE_RTREE \
        -DSQLITE_ENABLE_GEOPOLY \
        -DSQLITE_USE_URI \
        -DSQLITE_ENABLE_DBSTAT_VTAB \
        -DSQLITE_MAX_VARIABLE_NUMBER=250000"
      export CFLAGS="$CFLAGS $_amalgamation"

      ./configure \
         --host=${{host.triplet.gnu}} \
         --target=${{host.triplet.gnu}} \
         --prefix=/usr \
         --enable-threadsafe \
         --enable-readline \
         --enable-static \
         --enable-dynamic-extensions \
         --enable-fts3

      sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
      sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool

      make -j$(nproc) V=1

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: "sqlite-dev"
    description: "sqlite headers"
    pipeline:
      - uses: split/dev
    dependencies:
      runtime:
        - sqlite
    test:
      pipeline:
        - uses: test/pkgconf

  - name: "sqlite-doc"
    description: "sqlite documentation"
    pipeline:
      - uses: split/manpages

  - name: "sqlite-libs"
    description: "sqlite library"
    pipeline:
      - runs: |
          mkdir -p "${{targets.subpkgdir}}"/usr
          mv "${{targets.destdir}}"/usr/lib "${{targets.subpkgdir}}"/usr/

update:
  enabled: true
  release-monitor:
    identifier: 4877

test:
  pipeline:
    - name: "version check"
      runs: |
        sqlite3 --version
        sqlite3 help
    - name: "basic test"
      runs: |
        sqlite3 /tmp/test.db "CREATE TABLE test (id INT, name TEXT); INSERT INTO test VALUES (1, 'hello'); SELECT * FROM test;"
        for i in $(seq 2 100); do
          sqlite3 /tmp/test.db "INSERT INTO test VALUES ($i, '$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 13)');"
        done
        sqlite3 /tmp/test.db "SELECT * FROM test;"
    - name: "more sqlite tests"
      runs: |
        sqlite3 -header -csv /tmp/test.db "SELECT * FROM test LIMIT 5;"
        sqlite3 /tmp/test.db "SELECT * FROM test WHERE id > 50 LIMIT 5;"
        sqlite3 /tmp/test.db ".schema"
        sqlite3 /tmp/test.db "SELECT COUNT(*) FROM test;"
