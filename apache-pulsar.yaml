package:
  name: apache-pulsar
  version: 4.0.1
  epoch: 0
  description: Pulsar is a distributed pub-sub messaging platform with a very flexible messaging model and an intuitive client API.
  copyright:
    - license: Apache-2.0
  dependencies:
    runtime:
      - openjdk-17-default-jvm
      - openjdk-17-jre

environment:
  contents:
    packages:
      - busybox
      - maven
      - openjdk-17-default-jdk

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/apache/pulsar
      tag: v${{package.version}}
      expected-commit: 3ea527bf6b720dcfe074c4476257cce96ebc068a

  - runs: |
      ./mvnw install -Dlicense.skip -DskipTests

      # Build dumps everything into <module>/target
      cp -ar bin/ ${{targets.contextdir}}
      cp -ar conf/ ${{targets.contextdir}}/conf
      cp -ar target/ ${{targets.contextdir}}/target

      # Get all built classes
      for dir in \
        bouncy-castle \
        bouncy-castle/* \
        distribution \
        distribution/* \
        jclouds-shaded \
        jetcd-core-shaded \
        managed-ledger \
        microbench \
        pulsar-* \
        pulsar-functions/* \
        pulsar-io/* \
        pulsar-package-management/* \
        pulsar-transaction/* \
        structured-event-log \
        tiered-storage \
        tiered-storage/*; do
          if [ -d "${dir}" ] && [ -d "${dir}/target" ]; then
            mkdir -p "${{targets.contextdir}}/${dir}"
            cp -ar "${dir}/target/" "${{targets.contextdir}}/${dir}/target"
          fi
      done

  - uses: strip

update:
  enabled: true
  github:
    identifier: apache/pulsar
    use-tag: true
    strip-prefix: v

test:
  pipeline:
    - name: Test that all binaries are at least installed
      runs: |
        bin/pulsar --help
        bin/pulsar-admin --help
        bin/pulsar-client --help
        bin/pulsar-daemon --help
        bin/pulsar-managed-ledger-admin --help
        bin/pulsar-perf --help
        bin/pulsar-shell --help

    - name: Run Maven unit tests from source repo
      runs: |
        ./mvnw test
