package:
  name: linkerd2-cli-edge
  version: 24.10.2
  epoch: 0
  description: "CLI for interacting with linkerd"
  copyright:
    - license: Apache-2.0

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 3a78e22f92fc30b7357f6e241d29ae38f99a69f4
      repository: https://github.com/linkerd/linkerd2/
      tag: edge-${{package.version}}

  - runs: |
      go generate -mod=readonly ./pkg/charts/static
      go generate -mod=readonly ./jaeger/static
      go generate -mod=readonly ./multicluster/static
      go generate -mod=readonly ./viz/static

  - uses: go/build
    with:
      packages: ./cli
      tags: prod
      output: linkerd
      ldflags: -X github.com/linkerd/linkerd2/pkg/version.Version=edge-${{package.version}}

update:
  enabled: true
  github:
    identifier: linkerd/linkerd2
    tag-filter: edge-

test:
  pipeline:
    - name: linkerd version check
      runs: linkerd version --client
    - uses: test/kwok/cluster
    - name: linkerd CRDs install
      runs: linkerd install --crds | kubectl apply -f -
    - name: linkerd install
      runs: linkerd install | kubectl apply -f -
    - name: linkerd check
      runs: linkerd check
