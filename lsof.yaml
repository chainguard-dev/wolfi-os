package:
  name: lsof
  version: 4.99.3
  epoch: 0
  description: List Open Files
  copyright:
    - license: lsof

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - build-base
      - busybox
      - groff
      - libtool
      - linux-headers
      - openssf-compiler-options
      - pkgconf-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/lsof-org/lsof
      tag: ${{package.version}}
      expected-commit: 2e4c7a1a9bc7258dc5b6a3ab28ebca44174279a8

  - runs: autoreconf -vif

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: lsof-dev
    description: dev library for lsof
    dependencies:
      runtime:
        - lsof
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/pkgconf

  - name: lsof-doc
    pipeline:
      - uses: split/manpages
    description: lsof manpages

  - name: lsof-debug
    pipeline:
      - uses: split/debug
    description: lsof debug

update:
  enabled: true
  github:
    identifier: lsof-org/lsof

test:
  pipeline:
    - name: Verify lsof installation
      runs: |
        set +x
        fail() { echo "FAIL:" "$@"; exit 1; }

        # both -h and -v output to stderr
        lsof -h 2>&1 || fail "'lsof -h' exited $?"
        echo "PASS: 'lsof -h' exited 0"

        # output of 4.99.3 shows 4.99.0, and appears maybe to be by design.
        # so only check for major.minor in output.
        ver="${{package.version}}"
        majmin=${ver%.*}
        out=$(lsof -v 2>&1) || fail "'lsof -v' exited $?"
        echo "$out" | grep -q -F -- "$majmin" ||
          fail "'lsof -v' output did not include '$majmin': $out"
        echo "PASS: 'lsof -v' contained version '$majmin' in output"
