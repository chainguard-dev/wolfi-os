# Generated from https://git.alpinelinux.org/aports/plain/main/lsof/APKBUILD
package:
  name: lsof
  version: 4.99.3
  epoch: 0
  description: LiSt Open Files
  copyright:
    - license: custom

environment:
  contents:
    packages:
      - autoconf
      - automake
      - bash
      - build-base
      - busybox
      - groff
      - libtool
      - linux-headers
      - perl
      - pkgconf-dev

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 2e4c7a1a9bc7258dc5b6a3ab28ebca44174279a8
      repository: https://github.com/lsof-org/lsof
      tag: ${{package.version}}

  - runs: autoreconf -fiv

  - uses: autoconf/configure

  - uses: autoconf/make

  - uses: autoconf/make-install

  - uses: strip

subpackages:
  - name: lsof-doc
    pipeline:
      - uses: split/manpages
    description: lsof manpages

test:
  pipeline:
    - name: Verify lsof installation
      runs: |
        set +x
        fail() { echo "FAIL:" "$@"; exit 1; }

        # both -h and -v output to stderr
        lsof -h 2>&1 || fail "'lsof -h' exited $?"
        echo "PASS: 'lsof -h' exited 0"

        # output of 4.99.3 shows 4.99.0, and appears maybe to be by design.
        ver="${{package.version}}"
        majmin=${ver%.*}
        out=$(lsof -v 2>&1) || fail "'lsof -v' exited $?"
        echo "$out" | grep -q -F -- "$majmin" ||
          fail "'lsof -v' output did not include '$majmin': $out"
        echo "PASS: 'lsof -v' contained version '$majmin' in output"

update:
  enabled: true
  manual: false
  github:
    identifier: lsof-org/lsof
