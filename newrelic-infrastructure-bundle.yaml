package:
  name: newrelic-infrastructure-bundle
  version: 3.2.22
  epoch: 0
  description: New Relic Infrastructure containerised agent bundle
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - wolfi-baselayout
      - busybox
      - build-base
      - go
      - ca-certificates-bundle

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/newrelic/infrastructure-bundle
      tag: v${{package.version}}
      expected-commit: 040474c71354595f481ce14b8e9798bd7bff78f5
      destination: ${{package.name}}

  - working-directory: ${{package.name}}
    pipeline:
      - runs: |
          go run downloader.go

          case "${{build.arch}}" in
              x86_64)   export TARGETARCH="amd64" ;;
              aarch64)  export TARGETARCH="arm64" ;;
              *)        echo "Unsupported architecture: ${{build.arch}}"; exit 1 ;;
          esac

          cd ./out/$TARGETARCH

          mkdir -p ${{targets.contextdir}}/var
          mkdir -p ${{targets.contextdir}}/etc
          mkdir -p ${{targets.contextdir}}/usr

          mv ./var/db "${{targets.contextdir}}"/var
          mv ./etc/newrelic-infra "${{targets.contextdir}}"/etc

          mv ./usr/bin "${{targets.contextdir}}"/usr
          mv ./usr/share "${{targets.contextdir}}"/usr
      - uses: strip

update:
  enabled: true
  github:
    identifier: newrelic/infrastructure-bundle
    use-tag: true
    tag-filter: v
    strip-prefix: v
