package:
  name: supervisor
  version: 4.2.5
  epoch: 5
  description: Supervisor process control system for Unix (supervisord)
  copyright:
    - license: BSD-3-Clause
  dependencies:
    runtime:
      - py3-setuptools
      - supervisor-config

environment:
  contents:
    packages:
      - busybox
      - py3-pip
      - python3

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 99a3e3e240d9d13e143b306818731e224e1e73d2
      repository: https://github.com/Supervisor/supervisor
      tag: ${{package.version}}

  - uses: py/pip-build-install

  - name: drop installed tests
    runs: |
      # note that pip install does include tests but they are removed here.
      find "${{targets.contextdir}}" -name "tests" -exec rm -vrf '{}' +

  - uses: strip

subpackages:
  - name: supervisor-config
    description: Supervisor configuration
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/etc/logrotate.d"
          cat >${{targets.contextdir}}/etc/logrotate.d/supervisord <<"EOF"
          /var/log/supervisor/*.log {
            missingok
            weekly
            notifempty
            nocompress
          }
          EOF
          chmod 644 ${{targets.contextdir}}/etc/logrotate.d/supervisord

          mkdir -p "${{targets.contextdir}}/etc"
          cp supervisor/skel/sample.conf ${{targets.contextdir}}/etc/supervisord.conf
          sed -i 's/\;files\s.*/files = supervisord.d\/*.conf/g' "${{targets.contextdir}}/etc/supervisord.conf"

          if diff -u supervisor/skel/sample.conf ${{targets.contextdir}}/etc/supervisord.conf; then
            echo "supervisor/skel/sample.conf and /etc/supervisord.conf did not differ"
            exit 1
          fi

          chmod 600 ${{targets.contextdir}}/etc/supervisord.conf

  - name: supervisor-openrc
    description: system for controlling process state under UNIX (OpenRC init scripts)
    pipeline:
      - runs: |
          mkdir -p "${{targets.contextdir}}/etc/init.d/"
          cat >${{targets.contextdir}}/etc/init.d/supervisord <<"EOF"
          #!/sbin/openrc-run

          name="Supervisor"
          command="/usr/bin/supervisord"
          pidfile="/var/run/supervisord.pid"
          configfile="/etc/supervisord.conf"
          command_args="--nodaemon --pidfile ${pidfile} --configuration ${configfile}"
          command_background="yes"

          required_files="${configfile}"
          EOF
          chmod 755 ${{targets.contextdir}}/etc/init.d/supervisord

test:
  pipeline:
    - name: run bins with --help
      runs: |
        set +x
        for b in supervisorctl supervisord; do
            echo "execute: $b --help"
            $b --help 2>&1 || { echo "FAIL: '$b --help' exited $?"; exit 1; }
        done

update:
  enabled: true
  github:
    identifier: Supervisor/supervisor
    use-tag: true
