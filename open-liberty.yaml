package:
  name: open-liberty
  version: 24.0.0.10
  epoch: 0
  description: "Open Liberty is a highly composable, fast to start, dynamic application server runtime environment"
  resources:
    cpu: 32
    memory: 32Gi
  copyright:
    - license: EPL-2.0

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - curl
      - gradle
      - openjdk-21
      - openjdk-21-default-jvm
      - unzip
  environment:
    LANG: en_US.UTF-8
    JAVA_HOME: /usr/lib/jvm/java-21-openjdk

pipeline:
  - uses: git-checkout
    with:
      expected-commit: 9413bdccccd24746b89a1c3637bd627b3288fad3
      repository: https://github.com/OpenLiberty/open-liberty
      tag: gm-${{package.version}}

  - working-directory: dev
    runs: |
      ./gradlew --stacktrace cnf:initialize
      ./gradlew --stacktrace assemble
      ./gradlew --stacktrace releaseNeeded

      mkdir -p ${{targets.contextdir}}/usr/share/java/openliberty
      unzip -q cnf/release/dev/openliberty/${{package.version}}*/openliberty-${{package.version}}*.zip -d ${{targets.contextdir}}/usr/share/java/openliberty

  - uses: strip

update:
  enabled: true
  github:
    identifier: OpenLiberty/open-liberty
    strip-prefix: gm-
    tag-filter: gm-

test:
  environment:
    contents:
      packages:
        - openjdk-21-default-jvm
  pipeline:
    - runs: |
        export PATH="/usr/share/java/openliberty/wlp/bin:$PATH"
        server help
        client help
        server create
        server start
        client create
        server stop
